<% @nb_exercices = 0 %>
<% @nb_points_exercices = 0 %>

<% @nb_problemes = 0 %>
<% @nb_points_problemes = 0 %>

<% @nb_n1 = 0 %>
<% @nb_n2 = 0 %>
<% @nb_n3 = 0 %>
<% @nb_n4 = 0 %>
<% @nb_n5 = 0 %>



<% def affiche_exercices(chapter, acces) %>


  <% liste = chapter.exercises %>
  <% liste.sort!{|t1,t2|t1.position <=> t2.position} %>
  <% liste2 = chapter.qcms %>
  <% liste2.sort!{|t1,t2|t1.position <=> t2.position} %>
  <% un = 0 %>
  <% deux = 0 %>
  <% j = 1 %>
  <% k = 1 %>

  <% compteur = 0 %>

  <% (1..(liste.size+liste2.size)).each do |i| %>
  
    <% @nb_exercices = @nb_exercices + 1 %>

    <% encours = 0 %>
    <% if un >= liste.size %>
      <% encours = 2 %>
    <% else %>
      <% if deux >= liste2.size %>
        <% encours = 1 %>
      <% else %>
        <% if liste[un].position < liste2[deux].position %>
          <% encours = 1 %>
        <% else %>
          <% encours = 2 %>
        <% end %>
      <% end %>
    <% end %>

    <% if encours == 1 %>
      <% f = liste[un] %>
      <% @nb_points_exercices = @nb_points_exercices + f.value %>
      <% if f.online || current_user.sk.admin? %>

        <% compteur = compteur + 1 %>

        <% if k % 5 == 1 && k > 1 %>
          </div>
          <br/>
          <div class="btn-group" style="margin-top:5px;">
        <% elsif k == 1 %>
          <center>
          <div class="btn-group">
        <% end %>

        <% if acces %>

          <% exo = Solvedexercise.where(:user_id => current_user.sk.id, :exercise_id => f.id) %>
          <% if exo.size > 0 && ! current_user.sk.admin? %>
            <% exo = exo.first %>
            <% if exo.correct %>
              <button class="btn-success btn" onclick="location.href='<%= chapter_path(chapter, :type => 2, :which => f.id) %>'"><%= j %></button>
            <% else %>
              <button class="btn-danger btn" onclick="location.href='<%= chapter_path(chapter, :type => 2, :which => f.id) %>'"><%= j %></button>
            <% end %>
          <% elsif !f.online %>
            <button class="btn-warning btn" onclick="location.href='<%= chapter_path(chapter, :type => 2, :which => f.id) %>'"><%= '!' %></button>
          <% else %>
            <button class="btn btn" onclick="location.href='<%= chapter_path(chapter, :type => 2, :which => f.id) %>'"><%= j %></button>
          <% end %>

        <% else %>
          <button class="btn disabled"><%= j %></button>
        <% end %>

        <% j = j+1 if f.online %>
        <% k = k+1 %>
      <% end %>
      <% un = un + 1 %>
    <% else %>

      <% f = liste2[deux] %>
      <% @nb_points_exercices = @nb_points_exercices + f.value %>
      <% if f.online || current_user.sk.admin? %>

        <% compteur = compteur + 1 %>

        <% if k % 5 == 1 && k > 1 %>
          </div>
          <br/>
          <div class="btn-group" style="margin-top:5px;">
        <% elsif k == 1 %>
          <center>
          <div class="btn-group">
        <% end %>

        <% if acces %>

          <% qcm = Solvedqcm.where(:user_id => current_user.sk.id, :qcm_id => f.id) %>
          <% if qcm.size > 0 && ! current_user.sk.admin? %>
            <% qcm = qcm.first %>
            <% if qcm.correct %>
              <button class="btn-success btn" onclick="location.href='<%= chapter_path(chapter, :type => 3, :which => f.id) %>'"><%= j %></button>
            <% else %>
              <button class="btn-danger btn" onclick="location.href='<%= chapter_path(chapter, :type => 3, :which => f.id) %>'"><%= j %></button>
            <% end %>
          <% elsif !f.online %>
            <button class="btn-warning btn" onclick="location.href='<%= chapter_path(chapter, :type => 3, :which => f.id) %>'"><%= '!' %></button>
          <% else %>
            <button class="btn btn" onclick="location.href='<%= chapter_path(chapter, :type => 3, :which => f.id) %>'"><%= j %></button>
          <% end %>

        <% else %>
          <button class="btn disabled"><%= j %></button>
        <% end %>
        <% j = j+1 if f.online %>
        <% k = k+1 %>

      <% end %>
      <% deux = deux + 1 %>
    <% end %>

  <% end %>


<% if compteur == 0 %>
  <center><p><i> Aucun exercice. </i></p></center>
<% else %>
  </div>
  </center>
<% end %>


<% end %>






<% def affiche_problemes(chapter, acces) %>

  <% compteur = 0 %>

  <% listex = chapter.problems %>
  <% listex.sort!{|t1,t2|t1.position <=> t2.position} %>
  <% k = 1 %>
  <% j = 1 %>

  <% listex.each do |f| %>
  
    <% @nb_problemes = @nb_problemes + 1 %>
    <% @nb_points_problemes = @nb_points_problemes + f.value %>
    
    <% @nb_n1 = @nb_n1 + 1 if f.level == 1 %>
    <% @nb_n2 = @nb_n2 + 1 if f.level == 2 %>
    <% @nb_n3 = @nb_n3 + 1 if f.level == 3 %>
    <% @nb_n4 = @nb_n4 + 1 if f.level == 4 %>
    <% @nb_n5 = @nb_n5 + 1 if f.level == 5 %>

    <% if f.online || current_user.sk.admin? %>

      <% if k % 5 == 1 && k > 1 %>
        </div>
        <br/>
        <div class="btn-group" style="margin-top:5px;">
      <% elsif k == 1 %>
        <center>
        <div class="btn-group">
      <% end %>

      <% compteur = compteur + 1 %>

      <% if acces %>

        <% if current_user.sk.solved?(f) && ! current_user.sk.admin? %>
          <button class="btn-success btn" onclick="location.href='<%= chapter_path(chapter, :type => 4, :which => f.id) %>'"><%= j %></button>
        <% elsif !f.online %>
          <button class="btn-warning btn" onclick="location.href='<%= chapter_path(chapter, :type => 4, :which => f.id) %>'"><%= '!' %></button>
        <% else %>
          <% sub = current_user.sk.submissions.where(:problem_id => f.id).order('created_at') %>
          <% if sub.size == 0 || current_user.sk.admin? %>
            <button class="btn btn" onclick="location.href='<%= chapter_path(chapter, :type => 4, :which => f.id) %>'"><%= j %></button>
          <% else %>
            <% sub = sub.last %>
            <% if sub.status == 0 %>
              <button class="btn-warning btn" onclick="location.href='<%= chapter_path(chapter, :type => 4, :which => f.id) %>'"><%= j %></button>
            <% else %>
              <button class="btn-danger btn" onclick="location.href='<%= chapter_path(chapter, :type => 4, :which => f.id) %>'"><%= j %></button>
            <% end %>
          <% end %>
        <% end %>

      <% else %>
        <button class="btn disabled"><%= j %></button>
      <% end %>

      <% j = j+1 if f.online %>
      <% k = k+1 %>
    <% end %>
  <% end %>


<% if compteur == 0 %>
  <center><p><i>Aucun probl√®me.</i></p></center>
<% else %>
  </div>
  </center>
<% end %>


<% end %>



<% provide(:title, @section.name) %>

<h1>
  <span style="font-size:16px;"><%= link_to "Cours", sections_path %> ></span> <%= @section.name %>
</h1>


<h3>Introduction</h3>
   <%= raw(@section.description.gsub(/\\][ \r]*\n/,'\] ').gsub(/\$\$[ \r]*\n/,'$$ ').gsub(/<\/ol>[ \r]*\n/, '</ol>').gsub(/\n[ \r]*<\/ol>/, '</ol>').gsub(/<\/ul>[ \r]*\n/, '</ul>').gsub(/\n[ \r]*<\/ul>/, '</ul>').gsub(/\n[ \r]*<li>/, '<li>').gsub(/\n/, '<br/>')) %>
<br/><br/>
<% if current_user.sk.admin? %>
<%= link_to "Modifier l'introduction", edit_section_path(@section) %><br/><br/>
<% end %>

<h3>Chapitres</h3>

<% if !@fondation %>


<% chap = Array.new %>
<% debloque = Array.new %>
<% faisable = Array.new %>
<% faisable2 = Array.new %>
<% affiche = Array.new %>
<% nb_pre = Array.new %>
<% possible = SortedSet.new %>
<% retiens = Hash.new %>

<% n = 0 %>

<% Chapter.all.each do |c| %>
  <% if (c.online || current_user.sk.admin) && !c.section.fondation %>
    <% retiens[c.id] = n %>
    <% chap.push(c) %>
    <% debloque.push([]) %>
    <% faisable.push(-1) %>
    <% faisable2.push(-1) %>
    <% nb_pre.push(0) %>
    <% if c.section == @section %>
      <% affiche.push(true) %>
    <% else %>
      <% affiche.push(false) %>
    <% end %>
    <% n = n+1 %>
  <% end %>
<% end %>

<% (0..(n-1)).each do |i| %>
  <% if (chap[i].online || current_user.sk.admin) %>
    <% premier = true %>
    <% chap[i].prerequisites.each do |p| %>
      <% if !p.section.fondation %>
        <% debloque[retiens[p.id]].push(i) %>
        <% nb_pre[i] = nb_pre[i]+1 %>
        <% premier = false %>
      <% end %>
    <% end %>
    <% if premier %>
      <% if current_user.sk.chapters.exists?(chap[i]) %>
        <% faisable[i] = 0 %>
      <% else %>
        <% faisable[i] = 1 %>
      <% end %>
      <% faisable2[i] = 0 %>
      <% possible.add([faisable[i], faisable2[i], chap[i].level, i]) %>
    <% end %>
  <% end %>
<% end %>

<% i = 0 %>


<% while !possible.empty? %>
  <% encours = (possible.first)[3] %>
  <% possible.delete(possible.first) %>
  <% if affiche[encours] %>
    <% if faisable[encours] <= 1 || current_user.sk.admin %>
    
    <% lecas = 0 %>

      <% if faisable[encours] == 0 && !current_user.sk.admin %>
        <table style="border-radius:15px; background-color:#DDFFDD; border-collapse:separate;" class="table">
        <% lecas = 1 %>
      <% elsif !chap[encours].online %>
        <table style="border-radius:15px; background-color:#FFEEAA; border-collapse:separate;" class="table">
        <% lecas = 2 %>
      <% else %>
        <table style="border-radius:15px; background-color:#FFFFD0; border-collapse:separate;" class="table">
        <% lecas = 3 %>
      <% end %>
      
      <tr>
      <td colspan="3" style="border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-top-left-radius:15px; border-top-right-radius:15px;"><center><h3><%= link_to chap[encours].name, chap[encours] %>
      <% if lecas == 1 %>
        <i class="icon-ok"></i>
      <% elsif lecas == 2 %>
        (en construction)
      <% end %>  
      </h3></center>
      <div style="padding-left:15px; padding-right:15px; padding-bottom:10px;"><%= raw(chap[encours].description.gsub(/\$\$[ \r]*\n/,'$$ ').gsub(/<\/ol>[ \r]*\n/, '</ol>').gsub(/\n[ \r]*<\/ol>/, '</ol>').gsub(/<\/ul>[ \r]*\n/, '</ul>').gsub(/\n[ \r]*<\/ul>/, '</ul>').gsub(/\n[ \r]*<li>/, '<li>').gsub(/\n/, '<br/>')) %></div>
      </td>
      </tr>
      <tr>

     <td class="span4" style="padding-bottom:5px; border-left:1px solid black; border-bottom:1px solid black; border-bottom-left-radius:15px;">

      <center><h4>Th√©orie</h4></center>
      <% compteur = 0 %>
      <% liste = chap[encours].theories %>
      <% liste.sort!{|t1,t2|t1.position <=> t2.position} %>
      <% liste.each do |t| %>
        <% if t.online %>
          <% if compteur == 0 %>
            <ul>
          <% end %>
          <% compteur = compteur + 1 %>
          <li><%= link_to t.title, chapter_path(chap[encours], :type => 1, :which => t.id) %> <%= raw("<i class=\"icon-ok\"></i>") if current_user.sk.theories.exists?(t) %></li>
        <% end %>
      <% end %>

      <% if compteur == 0 %>
        <p style="margin-left:15px;"><i>Aucun point th√©orique.</i></p>
      <% else %>
        </ul>
      <% end %>

      </td>
    <% else %>
      <table style="border-radius:20px; background-color:#EEEEEE; border-collapse:separate;" class="table">
      <tr>
      <td colspan="3" style="border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-top-left-radius:15px; border-top-right-radius:15px;"><center><h3><%= chap[encours].name %></h3></center>
      <div style="padding-left:15px; padding-right:15px; padding-bottom:10px;"><%= raw(chap[encours].description.gsub(/\$\$[ \r]*\n/,'$$ ').gsub(/<\/ol>[ \r]*\n/, '</ol>').gsub(/\n[ \r]*<\/ol>/, '</ol>').gsub(/<\/ul>[ \r]*\n/, '</ul>').gsub(/\n[ \r]*<\/ul>/, '</ul>').gsub(/\n[ \r]*<li>/, '<li>').gsub(/\n/, '<br/>')) %>
      <br/><br/>
      <span style="color:red;">Chapitre non accessible. Veuillez d'abord compl√©ter :
      <% prems = true %>
      <% chap[encours].prerequisites.each do |p| %>
        <% if (!p.section.fondation && !current_user.sk.chapters.exists?(p)) %>
          <%= " - " if !prems %>
          <%= p.name %>
          <% prems = false %>
        <% end %>
      <% end %>
      </span>
      </div>
      </td>
      </tr>
      <tr>
      <td class="span4" style="padding-bottom:5px; border-left:1px solid black; border-bottom:1px solid black; border-bottom-left-radius:15px;">
      <center><h4>Th√©orie</h4></center>
      <% compteur = 0 %>
      <% liste = chap[encours].theories %>
      <% liste.sort!{|t1,t2|t1.position <=> t2.position} %>
      <% liste.each do |t| %>
        <% if t.online %>
          <% if compteur == 0 %>
            <ul>
          <% end %>
          <% compteur = compteur + 1 %>
          <li><%= t.title %></li>
        <% end %>
      <% end %>

      <% if compteur == 0 %>
        <p style="margin-left:15px;"><i>Aucun point th√©orique.</i></p>
      <% else %>
        </ul>
      <% end %>
      </td>
    <% end %>

    <td class="span4" style="padding-bottom:20px; border-bottom:1px solid black;">
    <center><h4>Exercices</h4></center>
    <% if faisable[encours] <= 1 || current_user.sk.admin? %>
      <% affiche_exercices(chap[encours],true) %>
    <% else %>
      <% affiche_exercices(chap[encours],false) %>
    <% end %>
    </td>
    <td class="span4" style="padding-bottom:20px; border-right:1px solid black; border-bottom:1px solid black; border-bottom-right-radius:15px;">
    <center><h4>Probl√®mes</h4></center>
    <% if faisable[encours] <= 1 || current_user.sk.admin? %>
      <% affiche_problemes(chap[encours],true) %>
    <% else %>
      <% affiche_problemes(chap[encours],false) %>
    <% end %>
    </td>
    </tr>
    </table>

  <% end %>
  <% debloque[encours].each do |d| %>
    <% nb_pre[d] = nb_pre[d] - 1 %>
    <% faisable[d] = [faisable[d], faisable[encours]+1].max %>
    <% faisable2[d] = [faisable2[d], faisable2[encours]+1].max %>
    <% if nb_pre[d] == 0 %>
      <% if current_user.sk.chapters.exists?(chap[d]) %>
        <% faisable[d] = 0 %>
      <% end %>
      <% possible.add([faisable[d], faisable2[d], chap[d].level, d]) %>
    <% end %>
  <% end %>
  <% i = i+1 %>
<% end %>



<% else %>



<% chap = Array.new %>
<% debloque = Array.new %>
<% faisable = Array.new %>
<% nb_pre = Array.new %>
<% possible = SortedSet.new %>
<% retiens = Hash.new %>

<% n = 0 %>

<% Chapter.all.each do |c| %>
  <% if (c.online || current_user.sk.admin) && c.section.fondation %>
    <% retiens[c.id] = n %>
    <% chap.push(c) %>
    <% debloque.push([]) %>
    <% faisable.push(-1) %>
    <% nb_pre.push(0) %>
    <% n = n+1 %>
  <% end %>
<% end %>

<% (0..(n-1)).each do |i| %>
  <% if (chap[i].online || current_user.sk.admin) %>
    <% premier = true %>
    <% chap[i].prerequisites.each do |p| %>
      <% if p.section.fondation %>
        <% debloque[retiens[p.id]].push(i) %>
        <% nb_pre[i] = nb_pre[i]+1 %>
        <% premier = false %>
      <% end %>
    <% end %>
    <% if premier %>
      <% possible.add([faisable[i], chap[i].level, i]) %>
    <% end %>
  <% end %>
<% end %>

<% i = 0 %>

<% while !possible.empty? %>

  <% encours = (possible.first)[2] %>
  <% possible.delete(possible.first) %>
  <% lecas = 0 %>

  <% if current_user.sk.chapters.exists?(chap[encours])  && !current_user.sk.admin %>
    <table style="border-radius:15px; background-color:#DDFFDD; border-collapse:separate;" class="table">
    <% lecas = 1 %>
  <% elsif !chap[encours].online %>
    <table style="border-radius:15px; background-color:#FFEEAA; border-collapse:separate;" class="table">
    <% lecas = 2 %>
  <% else %>
    <table style="border-radius:15px; background-color:#FFFFD0; border-collapse:separate;" class="table">
    <% lecas = 3 %>
  <% end %>
  <tr>
  <td colspan="3" style="border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-top-left-radius:15px; border-top-right-radius:15px;"><center><h3><%= link_to chap[encours].name, chap[encours] %>
  <% if lecas == 1 %>
    <i class="icon-ok"></i>
  <% elsif lecas == 2 %>
    (en construction)
  <% end %>  
  </h3></center>
  <div style="padding-left:15px; padding-right:15px; padding-bottom:10px;"><%= raw(chap[encours].description.gsub(/\$\$[ \r]*\n/,'$$ ').gsub(/<\/ol>[ \r]*\n/, '</ol>').gsub(/\n[ \r]*<\/ol>/, '</ol>').gsub(/<\/ul>[ \r]*\n/, '</ul>').gsub(/\n[ \r]*<\/ul>/, '</ul>').gsub(/\n[ \r]*<li>/, '<li>').gsub(/\n/, '<br/>')) %></div>
  </td>
  </tr>
  <tr>

  <td class="span4" style="padding-bottom:5px; border-bottom:1px solid black; border-left:1px solid black; border-bottom-left-radius:15px;">
  <center><h4>Th√©orie</h4></center>

  <% compteur = 0 %>
  <% liste = chap[encours].theories %>
  <% liste.sort!{|t1,t2|t1.position <=> t2.position} %>
  <% liste.each do |t| %>
    <% if t.online %>
      <% if compteur == 0 %>
        <ul>
      <% end %>
      <% compteur = compteur + 1 %>
      <li><%= link_to t.title, chapter_path(chap[encours], :type => 1, :which => t.id) %> <%= raw("<i class=\"icon-ok\"></i>") if current_user.sk.theories.exists?(t) %></li>
    <% end %>
  <% end %>

  <% if compteur == 0 %>
    <p style="margin-left:15px;"><i>Aucun point th√©orique.</i></p>
  <% else %>
    </ul>
  <% end %>
  </td>

  <td class="span4" style="padding-bottom:20px; border-bottom:1px solid black;">
  <center><h4>Exercices</h4></center>
  <% affiche_exercices(chap[encours],true) %>
  </td>
  <td class="span4" style="padding-bottom:20px; border-bottom:1px solid black; border-right:1px solid black; border-bottom-right-radius:15px;">
  <center><h4>Probl√®mes</h4></center>
  <% affiche_problemes(chap[encours],true) %>
  </td>
  </tr>
  </table>

  <% debloque[encours].each do |d| %>
    <% nb_pre[d] = nb_pre[d] - 1 %>
    <% faisable[d] = [faisable[d], faisable[encours]+1].max %>
    <% if nb_pre[d] == 0 %>
      <% possible.add([faisable[d], chap[d].level, d]) %>
    <% end %>
  <% end %>
  <% i = i+1 %>
<% end %>

<% end %>

<% if current_user.sk.admin? %>

<h3>Statistiques (uniquement visibles des administrateurs)</h3>
<h4>Exercices</h4>
<ul>
<li>Nombre total d'exercices : <%= @nb_exercices %></li>
<% if !@fondation %>
<li>Nombre total de points : <%= @nb_points_exercices %></li>
<% end %>
</ul>

<h4>Probl√®mes</h4>
<ul>
<li>Nombre de probl√®mes dans chaque niveau : <%= @nb_n1 %> / <%= @nb_n2 %> / <%= @nb_n3 %> / <%= @nb_n4 %> / <%= @nb_n5 %></li>
<li>Nombre total de probl√®mes : <%= @nb_problemes %></li>
<% if !@fondation %>
<li>Nombre total de points : <%= @nb_points_problemes %></li>
<% end %>
</ul>
<br/>

<center>
<%= button_to "Ajouter un chapitre", new_section_chapter_path(@section), method: :get, class: 'btn btn-large' %>
</center>

<% end %>
