<% def affiche_exercices(chapter, acces) %>


  <% liste = chapter.exercises %>
  <% liste.sort!{|t1,t2|t1.position <=> t2.position} %>
  <% liste2 = chapter.qcms %>
  <% liste2.sort!{|t1,t2|t1.position <=> t2.position} %>
  <% un = 0 %>
  <% deux = 0 %>
  <% j = 1 %>
  <% k = 1 %>
  
  <% compteur = 0 %>
  
  <% (1..(liste.size+liste2.size)).each do |i| %>
    
    <% encours = 0 %>
    <% if un >= liste.size %>
      <% encours = 2 %>
    <% else %>
      <% if deux >= liste2.size %>
        <% encours = 1 %>
      <% else %>
        <% if liste[un].position < liste2[deux].position %>
          <% encours = 1 %>
        <% else %>
          <% encours = 2 %>
        <% end %>
      <% end %>
    <% end %>
    
    <% if encours == 1 %>
      <% f = liste[un] %> 
      <% if f.online || current_user.sk.admin? %>
      
        <% compteur = compteur + 1 %>
      
        <% if k % 5 == 1 && k > 1 %>
          </div>
          <br/>
          <div class="btn-group" style="margin-top:5px;">
        <% elsif k == 1 %>
          <center>
          <div class="btn-group">
        <% end %>
        
        <% if acces %>
      
          <% exo = Solvedexercise.where(:user_id => current_user.sk.id, :exercise_id => f.id) %>
          <% if exo.size > 0 && ! current_user.sk.admin? %>
            <% exo = exo.first %>
            <% if exo.correct %>
              <button class="btn-success btn" onclick="location.href='<%= chapter_path(chapter, :type => 2, :which => f.id) %>'"><%= j %></button>
            <% else %>
              <button class="btn-danger btn" onclick="location.href='<%= chapter_path(chapter, :type => 2, :which => f.id) %>'"><%= j %></button>
            <% end %>
          <% elsif !f.online %>
            <button class="btn-warning btn" onclick="location.href='<%= chapter_path(chapter, :type => 2, :which => f.id) %>'"><%= '!' %></button>
          <% else %>
            <button class="btn btn" onclick="location.href='<%= chapter_path(chapter, :type => 2, :which => f.id) %>'"><%= j %></button>
          <% end %>
          
        <% else %>
          <button class="btn disabled"><%= j %></button>
        <% end %>

        <% j = j+1 if f.online %>
        <% k = k+1 %>
      <% end %>
      <% un = un + 1 %>
    <% else %>
    
      <% f = liste2[deux] %> 
      <% if f.online || current_user.sk.admin? %>
      
        <% compteur = compteur + 1 %>
      
        <% if k % 5 == 1 && k > 1 %>
          </div>
          <br/>
          <div class="btn-group" style="margin-top:5px;">
        <% elsif k == 1 %>
          <center>
          <div class="btn-group">
        <% end %>
        
        <% if acces %>
        
          <% qcm = Solvedqcm.where(:user_id => current_user.sk.id, :qcm_id => f.id) %>
          <% if qcm.size > 0 && ! current_user.sk.admin? %>
            <% qcm = qcm.first %>
            <% if qcm.correct %>
              <button class="btn-success btn" onclick="location.href='<%= chapter_path(chapter, :type => 3, :which => f.id) %>'"><%= j %></button>
            <% else %>
              <button class="btn-danger btn" onclick="location.href='<%= chapter_path(chapter, :type => 3, :which => f.id) %>'"><%= j %></button>
            <% end %>
          <% elsif !f.online %>
            <button class="btn-warning btn" onclick="location.href='<%= chapter_path(chapter, :type => 3, :which => f.id) %>'"><%= '!' %></button>
          <% else %>
            <button class="btn btn" onclick="location.href='<%= chapter_path(chapter, :type => 3, :which => f.id) %>'"><%= j %></button>
          <% end %>
          
        <% else %>
          <button class="btn disabled"><%= j %></button>
        <% end %>
        <% j = j+1 if f.online %>
        <% k = k+1 %>
          
      <% end %>
      <% deux = deux + 1 %>
    <% end %>
    
  <% end %>
  

<% if compteur == 0 %>
  <center><p><i> Aucun exercice. </i></p></center>
<% else %>
  </div>
  </center>
<% end %>


<% end %>






<% def affiche_problemes(chapter, acces) %>

  <% compteur = 0 %>

  <% listex = chapter.problems %>
  <% listex.sort!{|t1,t2|t1.position <=> t2.position} %>
  <% k = 1 %>
  <% j = 1 %>
  
  <% listex.each do |f| %>
    
    <% if f.online || current_user.sk.admin? %>
    
      <% if k % 5 == 1 && k > 1 %>
        </div>
        <br/>
        <div class="btn-group" style="margin-top:5px;">
      <% elsif k == 1 %>
        <center>
        <div class="btn-group">
      <% end %>
      
      <% compteur = compteur + 1 %>
      
      <% if acces %>
      
        <% if current_user.sk.solved?(f) && ! current_user.sk.admin? %>
          <button class="btn-success btn" onclick="location.href='<%= chapter_path(chapter, :type => 4, :which => f.id) %>'"><%= j %></button>
        <% elsif !f.online %>
          <button class="btn-warning btn" onclick="location.href='<%= chapter_path(chapter, :type => 4, :which => f.id) %>'"><%= '!' %></button>
        <% else %>
          <% sub = current_user.sk.submissions.where(:problem_id => f.id).order('created_at') %>
          <% if sub.size == 0 || current_user.sk.admin? %>
            <button class="btn btn" onclick="location.href='<%= chapter_path(chapter, :type => 4, :which => f.id) %>'"><%= j %></button>
          <% else %>
            <% sub = sub.last %>
            <% if sub.status == 0 %>
              <button class="btn-warning btn" onclick="location.href='<%= chapter_path(chapter, :type => 4, :which => f.id) %>'"><%= j %></button>
            <% else %>
              <button class="btn-danger btn" onclick="location.href='<%= chapter_path(chapter, :type => 4, :which => f.id) %>'"><%= j %></button>
            <% end %>
          <% end %>
        <% end %>
      
      <% else %>
        <button class="btn disabled"><%= j %></button>
      <% end %>
      
      <% j = j+1 if f.online %>
      <% k = k+1 %>
    <% end %>
  <% end %>


<% if compteur == 0 %>
  <center><p><i>Aucun problème.</i></p></center>
<% else %>
  </div>
  </center>
<% end %>


<% end %>







<% if !@fondation %>

<% provide(:title, @section.name) %>

<h1>
  <%= @section.name %>
</h1>

<h3>Introduction</h3>
   <%= raw(@section.description.gsub(/\\][ \r]*\n/,'\] ').gsub(/\$\$[ \r]*\n/,'$$ ').gsub(/<\/ol>[ \r]*\n/, '</ol>').gsub(/\n[ \r]*<\/ol>/, '</ol>').gsub(/<\/ul>[ \r]*\n/, '</ul>').gsub(/\n[ \r]*<\/ul>/, '</ul>').gsub(/\n[ \r]*<li>/, '<li>').gsub(/\n/, '<br/>')) %>	
<br/><br/>
<% if current_user.sk.admin? %>
<%= link_to "Modifier l'introduction", edit_section_path(@section) %><br/><br/>
<% end %>


<% chap = Array.new %>
<% debloque = Array.new %>
<% faisable = Array.new %>
<% faisable2 = Array.new %>
<% affiche = Array.new %>
<% nb_pre = Array.new %>
<% possible = SortedSet.new %>
<% retiens = Hash.new %>

<% n = 0 %>

<% Chapter.all.each do |c| %>
  <% if (c.online || current_user.sk.admin) && c.sections.count > 0 %>
    <% retiens[c.id] = n %>
    <% chap.push(c) %>
    <% debloque.push([]) %>
    <% faisable.push(-1) %>
    <% faisable2.push(-1) %>
    <% nb_pre.push(0) %>
    <% if c.sections.exists?(@section) %>
      <% affiche.push(true) %>
    <% else %>
      <% affiche.push(false) %>
    <% end %>
    <% n = n+1 %>
  <% end %>
<% end %>

<% (0..(n-1)).each do |i| %>
  <% if (chap[i].online || current_user.sk.admin) %>
    <% premier = true %>
    <% chap[i].prerequisites.each do |p| %>
      <% if p.sections.count > 0 %>
        <% debloque[retiens[p.id]].push(i) %>
        <% nb_pre[i] = nb_pre[i]+1 %>
        <% premier = false %>
      <% end %>
    <% end %>
    <% if premier %>
      <% if current_user.sk.chapters.exists?(chap[i]) %>
        <% faisable[i] = 0 %>
      <% else %>
        <% faisable[i] = 1 %>
      <% end %>
      <% faisable2[i] = 0 %>
      <% possible.add([faisable[i], faisable2[i], chap[i].level, i]) %>
    <% end %>
  <% end %>
<% end %>

<% i = 0 %>


<% while !possible.empty? %>
  <% encours = (possible.first)[3] %>
  <% possible.delete(possible.first) %>
  <% if affiche[encours] %>
    <% if faisable[encours] <= 1 || current_user.sk.admin %>
      
      <% if faisable[encours] == 0 && !current_user.sk.admin %>
        <table style="border:1px solid green;" class="table">
        <tr style="background-color:#DDFFDD;">
        <td colspan="3" style="border-top:1px solid green;"><center><h3><%= link_to chap[encours].name, chap[encours] %> <i class="icon-ok"></i></h3></center></td>
        </tr>
        <tr style="background-color:#DDFFDD;">
      <% elsif !chap[encours].online %>
        <table style="border:1px solid black;" class="table">
        <tr style="background-color:#FFEEAA;">
        <td colspan="3" style="border-top:1px solid black;"><center><h3><%= link_to chap[encours].name, chap[encours] %> (en construction)</h3></center></td>
        </tr>
        <tr style="background-color:#FFEEAA;">
      <% else %>
        <table style="border:1px solid black;" class="table">
        <tr style="background-color:#FFFFE0;">
        <td colspan="3" style="border-top:1px solid black;"><center><h3><%= link_to chap[encours].name, chap[encours] %></h3></center></td>
        </tr>
        <tr style="background-color:#FFFFE0;">
      <% end %>

     <td class="span4">
      
      <center><h4>Théorie</h4></center>
      <% compteur = 0 %>
      <% liste = chap[encours].theories %>
      <% liste.sort!{|t1,t2|t1.position <=> t2.position} %>
      <% liste.each do |t| %>
        <% if t.online %>
          <% if compteur == 0 %>
            <ul>
          <% end %>
          <% compteur = compteur + 1 %>
          <li><%= link_to t.title, chapter_path(chap[encours], :type => 1, :which => t.id) %> <%= raw("<i class=\"icon-ok\"></i>") if current_user.sk.theories.exists?(t) %></li>
        <% end %>
      <% end %>	
      
      <% if compteur == 0 %>
        <p style="margin-left:15px;"><i>Aucun point théorique.</i></p>
      <% else %>
        </ul>
      <% end %>
      
      </td>
    <% else %>
      <table style="border:1px solid black;" class="table">
      <tr style="background-color:#EEEEEE;">
      <td colspan="3" style="border-top:1px solid black;"><center><h3><%= chap[encours].name %></h3></center>
      <p style="color:red;">Vous devez d'abord compléter :
      <% prems = true %>
      <% chap[encours].prerequisites.each do |p| %>
        <% if (p.sections.count > 0 && !current_user.sk.chapters.exists?(p)) %>
          <%= " - " if !prems %>
          <%= p.name %>
          <% prems = false %>
        <% end %>
      <% end %>
      </p>
      </td>
      </tr>
      <tr style="background-color:#EEEEEE;">
      <td class="span4">
      <center><h4>Théorie</h4></center>
      <% liste = chap[encours].theories %>
      <% liste.sort!{|t1,t2|t1.position <=> t2.position} %>
      <% liste.each do |t| %>
      <% compteur = 0 %>
        <% if t.online %>
          <% if compteur == 0 %>
            <ul>
          <% end %>
          <% compteur = compteur + 1 %>
          <li><%= t.title %></li>
        <% end %>
      <% end %>	
      
      <% if compteur == 0 %>
        <p style="margin-left:15px;"><i>Aucun point théorique.</i></p>
      <% else %>
        </ul>
      <% end %>
      </td>
    <% end %>
    
    <td class="span4">
    <center><h4>Exercices</h4></center>
    <% if faisable[encours] <= 1 || current_user.sk.admin? %>
      <% affiche_exercices(chap[encours],true) %>
    <% else %>
      <% affiche_exercices(chap[encours],false) %>
    <% end %>
    </td>
    <td class="span4">
    <center><h4>Problèmes</h4></center>
    <% if faisable[encours] <= 1 || current_user.sk.admin? %>
      <% affiche_problemes(chap[encours],true) %>
    <% else %>
      <% affiche_problemes(chap[encours],false) %>
    <% end %>
    </td>
    </tr>
    </table>
    
  <% end %>
  <% debloque[encours].each do |d| %>
    <% nb_pre[d] = nb_pre[d] - 1 %>
    <% faisable[d] = [faisable[d], faisable[encours]+1].max %>
    <% faisable2[d] = [faisable2[d], faisable2[encours]+1].max %>
    <% if nb_pre[d] == 0 %>
      <% if current_user.sk.chapters.exists?(chap[d]) %>
        <% faisable[d] = 0 %>
      <% end %>
      <% possible.add([faisable[d], faisable2[d], chap[d].level, d]) %>
    <% end %>
  <% end %>
  <% i = i+1 %>
<% end %>


<br/>
<center>
<%= link_to "Retour à la liste des cours", sections_path %>
</center>





<% else %>

<% provide(:title, "Fondements") %>

<h1>
  Fondements
</h1>

<h3>Introduction</h3>
  Vous trouverez ici certaines bases mathématiques sans lesquelles la compréhension des sections plus avancées risque d'être compliquée. Il n'est pas nécessaire de compléter ces chapitres pour accéder à la suite des cours.<br/><br/>


<% chap = Array.new %>
<% debloque = Array.new %>
<% faisable = Array.new %>
<% nb_pre = Array.new %>
<% possible = SortedSet.new %>
<% retiens = Hash.new %>

<% n = 0 %>

<% Chapter.all.each do |c| %>
  <% if (c.online || current_user.sk.admin) && c.sections.count == 0 %>
    <% retiens[c.id] = n %>
    <% chap.push(c) %>
    <% debloque.push([]) %>
    <% faisable.push(-1) %>
    <% nb_pre.push(0) %>
    <% n = n+1 %>
  <% end %>
<% end %>

<% (0..(n-1)).each do |i| %>
  <% if (chap[i].online || current_user.sk.admin) %>
    <% premier = true %>
    <% chap[i].prerequisites.each do |p| %>
      <% if p.sections.count > 0 %>
        <% debloque[retiens[p.id]].push(i) %>
        <% nb_pre[i] = nb_pre[i]+1 %>
        <% premier = false %>
      <% end %>
    <% end %>
    <% if premier %>
      <% possible.add([faisable[i], chap[i].level, i]) %>
    <% end %>
  <% end %>
<% end %>

<% i = 0 %>

<% while !possible.empty? %>

  <% encours = (possible.first)[2] %>
  <% possible.delete(possible.first) %>

  <% if current_user.sk.chapters.exists?(chap[encours])  && !current_user.sk.admin %>
    <table style="border:1px solid green;" class="table">
    <tr style="background-color:#DDFFDD;">
    <td colspan="3" style="border-top:1px solid green;"><center><h3><%= link_to chap[encours].name, chap[encours] %> <i class="icon-ok"></i></h3></center></td>
    </tr>
    <tr style="background-color:#DDFFDD;">
  <% elsif !chap[encours].online %>
    <table style="border:1px solid black;" class="table">
    <tr style="background-color:#FFEEAA;">
    <td colspan="3" style="border-top:1px solid black;"><center><h3><%= link_to chap[encours].name, chap[encours] %> (en construction)</h3></center></td>
    </tr>
    <tr style="background-color:#FFEEAA;">
  <% else %>
    <table style="border:1px solid black;" class="table">
    <tr style="background-color:#FFFFE0;">
    <td colspan="3" style="border-top:1px solid black;"><center><h3><%= link_to chap[encours].name, chap[encours] %></h3></center></td>
    </tr>
    <tr style="background-color:#FFFFE0;">
  <% end %>
  
  <td class="span4">
  <center><h4>Théorie</h4></center>

  <% compteur = 0 %>
  <% liste = chap[encours].theories %>
  <% liste.sort!{|t1,t2|t1.position <=> t2.position} %>
  <% liste.each do |t| %>
    <% if t.online %>
      <% if compteur == 0 %>
        <ul>
      <% end %>
      <% compteur = compteur + 1 %>
      <li><%= link_to t.title, chapter_path(chap[encours], :type => 1, :which => t.id) %> <%= raw("<i class=\"icon-ok\"></i>") if current_user.sk.theories.exists?(t) %></li>
    <% end %>
  <% end %>	
  
  <% if compteur == 0 %>
    <p style="margin-left:15px;"><i>Aucun point théorique.</i></p>
  <% else %>
    </ul>
  <% end %>
  </td>
  
  <td class="span4">
  <center><h4>Exercices</h4></center>
  <% affiche_exercices(chap[encours],true) %>
  </td>
  <td class="span4">
  <center><h4>Problèmes</h4></center>
  <% affiche_problemes(chap[encours],true) %>
  </td>
  </tr>
  </table>
  
  <% debloque[encours].each do |d| %>
    <% nb_pre[d] = nb_pre[d] - 1 %>
    <% faisable[d] = [faisable[d], faisable[encours]+1].max %>
    <% if nb_pre[d] == 0 %>
      <% possible.add([faisable[d], chap[d].level, d]) %>
    <% end %>
  <% end %>
  <% i = i+1 %>
<% end %>


<br/>
<center>
<%= link_to "Retour à la liste des cours", sections_path %>
</center>

<% end %>
