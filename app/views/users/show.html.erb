<% mois = ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"] %>

<% colors = ["#FFFFBB", "#FFBBBB", "#FFDD77", "#CCFFCC", "#CFF5FF", "#DDDDFF"] %>

<% provide(:title, @user.name) %>

<style type="text/css">

html>body thead.fixed tr {
	display: block;
}

html>body tbody.scroll {
	display: block;
	max-height: 440px;
	overflow-y: scroll;
	width: 100%;
}
</style>


<% if @user.admin %>
  <h1><b><%= @user.name %></b>
  <span style="font-size:18px; margin-left:100px;">(<%= @user.email %><%= " - email non confirmé" if !@user.email_confirm %>)</span>
  </h1>
  <b>Administrateur</b><br/>
<% else %>


<% actualrating = @user.point.rating %>
<% niveau = @user.level %>

<h1 style="color:<%= niveau[:color] %>;"><b><%= @user.name %></b><span style="margin-left:30px;">-</span><span style="margin-left:30px;"><%= niveau[:name] %></span>
<% if signed_in? && current_user.sk.admin %>
<span style="color:<%= niveau[:color] %>; margin-left:100px; font-size:18px;">(<%= @user.email %><%= " - email non confirmé" if !@user.email_confirm %>)</span>
<% end %>
</h1>

<% cansee = Array.new %>

<% if signed_in? && current_user.sk.admin %>
  <% Chapter.all.to_a.each do |c| %>
    <% cansee[c.id] = true %>
  <% end %>
<% else %>

  <% debloque = Array.new %>
  <% Chapter.all.to_a.each do |c| %>
    <% debloque[c.id] = false %>
  <% end %>
  
  <% signed_in? && current_user.sk.chapters.each do |c| %>
    <% debloque[c.id] = true %>
  <% end %>

  <% Chapter.all.to_a.each do |c| %>
    <% cansee[c.id] = true %>
    <% if !c.section.fondation %>
      <% c.prerequisites.each do |p| %>
        <% if !p.section.fondation && !debloque[p.id] %>
          <% cansee[c.id] = false %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% end %>


  <div class="row">

  <div class="col-lg-7 col-sm-12 col-xs-12">
  <h2>Résolutions</h2>
  <br/>
  <% exercises = @user.solvedexercises.where(:correct => true) %>
  <% qcms = @user.solvedqcms.where(:correct => true) %>
  <% problems = @user.solvedproblems %>
  <% activite = Array.new %>

  <% exercises.each do |e| %>
    <% pt = e.exercise.value %>
    <% pt = 0 if e.exercise.chapter.section.fondation %>
    <% activite.push({:time => e.updated_at, :type => 2, :id => e.exercise.id, :pt => pt, :chapter => e.exercise.chapter.name, :c_id => e.exercise.chapter.id, :section => e.exercise.chapter.section.id, :fondation => e.exercise.chapter.section.fondation}) %>
  <% end %>
  <% qcms.each do |q| %>
    <% pt = q.qcm.value %>
    <% pt = 0 if q.qcm.chapter.section.fondation %>
    <% activite.push({:time => q.updated_at, :type => 3, :id => q.qcm.id,  :pt => pt, :chapter => q.qcm.chapter.name, :c_id => q.qcm.chapter.id, :section => q.qcm.chapter.section.id, :fondation => q.qcm.chapter.section.fondation}) %>
  <% end %>
  <% problems.each do |p| %>
    <% pt = p.problem.value %>
    <% pt = 0 if p.problem.section.fondation %>
    
    <% peutvoir = true %>
    <% if !signed_in? || !current_user.sk.admin? %>
      <% p.problem.chapters.each do |c| %>
        <% peutvoir = false if !debloque[c.id] %>
      <% end %>      
    <% end %>
    
    <% activite.push({:time => p.updated_at, :type => 4, :id => p.problem.id, :peutvoir => peutvoir, :pt => pt, :number => p.problem.number, :level => p.problem.level, :section => p.problem.section.id, :fondation => p.problem.section.fondation}) %>
  <% end %>

  <% act = activite.sort{ |a, b| b[:time] <=> a[:time]} %>

  <% actperday = Array.new %>

  <% previousdate = Date.new(1980,1,1) %>
  <% encours = -1 %>

  <% parquoi = "" %>
  
  <% inscription = @user.created_at %>

  <% if act.size > 0 %>

    <% if inscription.in_time_zone.day != DateTime.now.in_time_zone.day || inscription.in_time_zone.month != DateTime.now.in_time_zone.month || inscription.in_time_zone.year != DateTime.now.in_time_zone.year %>
      <% parquoi = "jour" %>
    <% elsif inscription.in_time_zone.hour < act.first[:time].in_time_zone.hour - 1 %>
      <% parquoi = "heure" %>
    <% else %>
      <% parquoi = "minute" %>
    <% end %>

    <table class="table table-bordered hidden-xs" style="width:606px;">
    <thead class="fixed">
    <tr><th style="width:150px;">Date</th><th style="width:50px;"><center>Heure</center></th></th><th style="width:340px;">Quoi</th><th style="width:66px;"><center>Points</center></th></tr>
    </thead>
    <tbody class="scroll">
  <% end %>
  
  <% act.each do |a| %>
    <% date = a[:time].in_time_zone %>

    <% if parquoi == "jour" %>
      <% dateday = Time.zone.local(date.year, date.month, date.day, 0, 0, 0) %>
    <% elsif parquoi == "heure" %>
      <% dateday = Time.zone.local(date.year, date.month, date.day, date.hour, 0, 0) %>
    <% else %>
      <% dateday = Time.zone.local(date.year, date.month, date.day, date.hour, date.min, 0) %>
    <% end %>

    <% if a[:pt] > 0 %>
      <% if dateday != previousdate %>
        <% encours = encours+1 %>
        <% actperday.push({:time => dateday, :pt => a[:pt], :chapter => a[:chapter]}) %>
      <% else %>
        <% actperday[encours][:pt] = actperday[encours][:pt] + a[:pt] %>
      <% end %>
      <% previousdate = dateday %>
    <% end %>

    
    <tr style="background-color:<%= "#F5F5F5" if a[:fondation] %> <%= colors[a[:section]-1] if !a[:fondation] %>;">
    <td style="width:150px;"><%= date.day %> <%= mois[date.month-1] %> <%= date.year %> </td>
    <td style="width:50px;"><center> <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %></center></td>
    <td style="width:340px;">
    <% if a[:type] <= 3 %>
      <% if cansee[a[:c_id]] %>
        <%= link_to "Exercice", chapter_path(a[:c_id], :type => a[:type], :which => a[:id]) %>
      <% else %>
        Exercice
      <% end %>
      <%= "(#{a[:chapter]})" %>
    <% else %>
      <% if a[:peutvoir] %>
        <%= link_to "Problème ##{a[:number]}", problem_path(a[:id]) %>
      <% else %>
        Problème #<%= a[:number] %>
      <% end %>
      <%= "(Niveau #{a[:level]})" %>
    <% end %>
    </td>
    <td style="width:50px;">
    <center>
      <%= "+ #{a[:pt]}" if a[:pt] > 0 %>
    </center>
    </td>
    </tr>
    
  <% end %>

  <% if act.size > 0 %>
    </tbody>
    </table>
  <% else %>
    <div class="hidden-xs"><b>Aucune activité.</b></div>
  <% end %>
  
  
  
  <% if act.size > 0 %>

    <table class="table table-bordered visible-xs" style="width:356px;">
    <thead class="fixed">
    <tr><th style="width:150px;">Date</th><th style="width:140px;">Quoi</th><th style="width:66px;"><center>Points</center></th></tr>
    </thead>
    <tbody class="scroll">
  <% end %>
  
  <% act.each do |a| %>
    <% date = a[:time].in_time_zone %>
    
    <tr style="background-color:<%= "#F5F5F5" if a[:fondation] %> <%= colors[a[:section]-1] if !a[:fondation] %>;">
    <td style="width:150px;"><%= date.day %> <%= mois[date.month-1] %> <%= date.year %> </td>
    <td style="width:140px;">
    <% if a[:type] <= 3 %>
      <% if cansee[a[:c_id]] %>
        <%= link_to "Exercice", chapter_path(a[:c_id], :type => a[:type], :which => a[:id]) %>
      <% else %>
        Exercice
      <% end %>
    <% else %>
      <% if a[:peutvoir] %>
        <%= link_to "Problème ##{a[:number]}", problem_path(a[:id]) %>
      <% else %>
        Problème #<%= a[:number] %>
      <% end %>
    <% end %>
    </td>
    <td style="width:50px;">
    <center>
      <%= "+ #{a[:pt]}" if a[:pt] > 0 %>
    </center>
    </td>
    </tr>
    
  <% end %>

  <% if act.size > 0 %>
    </tbody>
    </table>
  <% else %>
    <div class="visible-xs"><b>Aucune activité.</b></div>
  <% end %>
  
  

  </div>

  <div class="col-lg-5 col-sm-12 col-xs-12">

  <center><p style="font-size:24px; margin-top:80px;">Score : <%= actualrating %></p></center>
  <br/>


  <% if actualrating > 0 %>

  <% p = Pointspersection.where(:user_id => @user) %>
  <% total = 0 %>
  <% possible2 = SortedSet.new %>

  <% Section.order(:id).where(:fondation => false).to_a.each do |s| %>
    <% rate = p.where(:section_id => s.id).first.points %>
    <% total = total + rate %>

    <% possible2.add([rate, s.name, s.id]) %>
  <% end %>

  <center>
  <canvas id="Camembert" width="240" height="240">
  Votre navigateur ne supporte pas les canvas.
  </canvas>
  </center>

  <center>
  <table class="table table-bordered hidden-xs" style="width:360px; margin-top:20px;">
  <% p = Pointspersection.where(:user_id => @user) %>
  <tr>
  <% i = 0 %>
  <% Section.order(:id).where(:fondation => false).to_a.each do |s| %>
    <% rate = p.where(:section_id => s.id).first.points %>

    <td style="width:180px; text-align:center; background-color:<%= colors[s.id-1] %>"><%= s.name %></td>
    <% i = i+1 %>
    <% if i == 2 || i == 4 %>
      </tr><tr>
    <% end %>

  <% end %>
  </tr>
  </table>
  
  <table class="table table-bordered visible-xs" style="width:250px; margin-top:20px;">
  <% p = Pointspersection.where(:user_id => @user) %>
  <% Section.order(:id).where(:fondation => false).to_a.each do |s| %>
    <% rate = p.where(:section_id => s.id).first.points %>
    <tr><td style="width:250px; text-align:center; background-color:<%= colors[s.id-1] %>"><%= s.name %></td></tr>
  <% end %>
  </table>
  
  
  </center>


  <script>
  var d=document.getElementById("Camembert");
  var ctx=d.getContext("2d");

  ctx.beginPath();
  ctx.arc(120, 120, 115, 0, 2 * Math.PI, false);
  ctx.fillStyle = 'white';
  ctx.fill();
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#888888';
  ctx.stroke();
  prec = 0;
  <% while !possible2.empty? %>
    <% if (possible2.first)[0] > 0 %>
      ctx.beginPath();
      ctx.arc(120,120,115, prec, prec + (2 * Math.PI * <%= (possible2.first)[0] %>) / <%= total %>, false);
      prec = prec + (2 * Math.PI * <%= (possible2.first)[0] %>) / <%= total %>;
      ctx.lineTo(120, 120);
      ctx.closePath();
      ctx.fillStyle= "<%= colors[(possible2.first)[2]-1] %>";
      ctx.fill();
      ctx.lineWidth = 1;
      ctx.strokeStyle="#888888";
      ctx.stroke();
    <% end %>
    <% possible2.delete(possible2.first) %>
  <% end %>

  </script>

  <% end %>

  <br/>
  <center>Inscription : <%= inscription.in_time_zone.day %> <%= mois[inscription.in_time_zone.month-1] %> <%= inscription.in_time_zone.year %></center><br/>

  </div>

  </div>


  <% if actualrating > 0 %>

  <div class="row">

  <div class="col-sm-12 col-xs-12">

  <h2>Evolution</h2>
  <br/>
  <center>
  
  <div id="contenant" style="width:100%; max-width:900px; height:480px; position:relative; display:block;">
  <canvas id="myCanvas" width="900" height="480" style="position:absolute; left:0px; top: 0px;">
  Votre navigateur ne supporte pas les canvas.
  </canvas>

  <% @niveaux = Color.order(:pt).to_a %>
  
  <% i = 1 %>
  <% numerolevel = 0 %>
  
  <% @niveaux.each do |n| %>
    <% if niveau.id == n.id %>
      <% numerolevel = i %>
    <% end %>
    <% i = i+1 %>
  <% end %>
  
  <% nombrelevel = i-1 %>
  
  <% maxi = 0 %>
  
  
  <% if numerolevel == nombrelevel %>
    <% maxi = 1.2*actualrating %>
  <% else %>
    <% maxi = 1.1*@niveaux[numerolevel][:pt] %>
  <% end %>

  </div>
  </center>
  
  
  <script type="text/javascript">
  	$(document).ready( function(){
  		
  		//Get the canvas & context
  		var c = $('#myCanvas');
  		var ctx = c.get(0).getContext('2d');
  		var container = $(c).parent();
  		
  		//Run function when browser  resize
	  	$(window).resize( respondCanvas );
	  	
	  	function respondCanvas(){
  			c.attr('width', $(container).width() ); //max width
  			c.attr('height', 480*$(container).width()/900.0); //max height
  			
  			document.getElementById('contenant').style.height = 480*$(container).width()/900.0 + "px"
  			
  			//Redraw & reposition content
  			var x = c.width();
  			var y = c.height();  
  			
  			var pct = c.width()/900.0;
  						
  ctx.beginPath();
  ctx.rect(pct*50, pct*5, pct*806, pct*450);
  ctx.fillStyle = 'white';
  ctx.fill();
  ctx.lineWidth = 2;
  ctx.strokeStyle = 'black';
  ctx.stroke();
  
  <% i = 1 %>
  
  var prec = 1000;
  
  <% @niveaux.each do |n| %>
    <% if i > 1 %>
      <% haut = [450 - 450*(n.pt/maxi), 0].max %>
      <% if haut > 0 %>
        ctx.font="14px Arial";
        ctx.fillStyle = 'black';
        ctx.textAlign = 'right';
        
        if (pct > 0.7){
        
          if (pct * <%= haut %> < prec - 13){
            ctx.fillText(<%= n.pt %>,pct*44,pct*<%= haut+10 %>);
            prec = pct * <%= haut %>;
          }
        
        ctx.beginPath();
        ctx.moveTo(pct*50, pct*<%= haut+5 %>);
        ctx.lineTo(pct*856, pct*<%= haut+5 %>);
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'white';
        ctx.stroke();
        
        }
      <% end %>
    <% end %>
    
    <% if i == nombrelevel %>
      <% bas = [450 - 450*(n.pt/maxi) , 0].max %>
      <% haut = 0 %>
    <% else %>
      <% bas = [450 - 450*(n.pt/maxi), 0].max %>
      <% haut = [450 - 450*(@niveaux[i].pt/maxi), 0].max %>
    <% end %>
    <% if bas > haut %>
      ctx.beginPath();
      ctx.rect(pct*50, pct*<%= haut+5 %>, pct*806, pct*<%= bas - haut %>);
      ctx.fillStyle = '<%= n.font_color %>';
      ctx.fill();
    <% end %>
    <% i = i+1 %>
  <% end %>
  

  ctx.fillStyle = 'black';
  ctx.strokeStyle = 'black';

    <% last = actperday.first[:time].to_time.to_i %>
    
    <% if parquoi == "jour" %>
      <% first = [inscription.to_time.to_i, actperday.last[:time].to_time.to_i - 86400].min %>
    <% elsif parquoi == "heure" %>
      <% first = [inscription.to_time.to_i, actperday.last[:time].to_time.to_i - 3600].min %>
    <% else %>
      <% first = [inscription.to_time.to_i, actperday.last[:time].to_time.to_i - 60].min %>
    <% end %>
    
    <% previousw = 2000 %>

    <% actperday.each do |a| %>
      <% w = 3 + 800*(a[:time].to_time.to_i - first)/(last-first) %>
      
      <% if previousw - w > 50 %>
        ctx.font="12px Arial";
        ctx.fillStyle = 'black';
        ctx.textAlign = 'center';
        
        if (pct > 0.7){
      
        <% if parquoi == "jour" %>
          ctx.fillText("<%= "0" if a[:time].day < 10 %><%= a[:time].day %>/<%= "0" if a[:time].month < 10 %><%= a[:time].month %>/<%= "0" if (a[:time].year % 2000) < 10 %><%= (a[:time].year % 2000) %>",pct*<%= 50+w %>,pct*471);
        <% elsif parquoi == "heure" %>
          ctx.fillText("<%= "0" if a[:time].hour < 10 %><%= a[:time].hour %>h",pct*<%= 50+w %>,pct*471);
        <% else %>
          ctx.fillText("<%= "0" if a[:time].hour < 10 %><%= a[:time].hour %>h<%= "0" if a[:time].min < 10 %><%= a[:time].min %>",pct*<%= 50+w %>,pct*471);
        <% end %>
        
        }
      
        <% (0..22).each do |i| %>
          ctx.beginPath();
          ctx.moveTo(pct*<%= 50+w %>, pct*<%= 20*i+5 %>);
          ctx.lineTo(pct*<%= 50+w %>, pct*<%= 20*i+15 %>);
          ctx.lineWidth = 2;
          ctx.strokeStyle = 'white';
          ctx.stroke();
        <% end %>
        <% previousw = w %>
      <% end %>
    <% end %>
    
    <% w = 3 %>
    <% r = 0 %>
    <% previousr = r %>
    <% h = 450 %>
    
    <% prevw = w %>
    <% prevh = h %>

    <% actperday.reverse.each do |a| %>
      <% w = 3 + 800*(a[:time].to_time.to_i - first)/(last-first) %>
      <% r = previousr + a[:pt] %>
      <% previousr = r %>
      <% h = 450 - 450*(r/maxi) %>
      ctx.beginPath();
      ctx.moveTo(pct*<%= 50+prevw %>, pct*<%= prevh+5 %>);
      ctx.lineTo(pct*<%= 50+w %>, pct*<%= h+5 %>);
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'black';
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(pct*<%= 50+w %>, pct*<%= h+5 %>, 3, 0, 2 * Math.PI, true);
      ctx.fill();
      <% prevw = w %>
      <% prevh = h %>
    <% end %>
    
		}
		
		//Initial call
		respondCanvas();
  	});
  	
  	
</script>

  <script> 
  
  


  </script>

  </div>
  </div>

  <% end %>
  
<% end %>

<% if signed_in? && current_user.sk.admin? %>
  <br/>
  <center>
  <% i = 0 %>
    <% if !@user.root %>
      <%= " | " if i > 0 %>
      <% i = i+1 %>
      <% if @user.active %>
        <%= link_to "Interdire l'accès à cet utilisateur", user_unactivate_path(@user), data: { confirm: "Etes-vous sûr de vouloir interdire l'accès au site à #{@user.name}?" } %>
      <% else %>
        <%= link_to "Rendre l'accès à cet utilisateur", user_reactivate_path(@user), data: { confirm: "Etes-vous sûr de vouloir rendre l'accès au site à #{@user.name}?" } %>
      <% end %>
    <% end %>
    <% if current_user.sk.root? %>
      <%= " | " if i > 0 %>
      <% i = i+1 %>
      <%= link_to 'Supprimer cet utilisateur', @user, method: :delete, data: { confirm: "ATTENTION : Ne supprimez un utilisateur que s'il s'agit d'un robot ou d'une personne mal intentionnée. Cette action supprimera tous ses messages et toutes ses données. Privilégiez une interdiction d'accès si possible. Etes-vous sûr de vouloir supprimer #{@user.name}?" }, :style => "color:red;" %>
    <% end %>
    <% if @user.email_confirm && !@user.admin %>
      <%= " | " if i > 0 %>
      <% i = i+1 %>
      <%= link_to 'Voir le site comme cet utilisateur', user_take_skin_path(@user), data: { confirm: "Vous allez voir tout le site comme #{@user.name} le voit." } %>
    <% end %>
    <% if current_user.sk.root && !@user.admin %>
      <%= " | " if i > 0 %>
      <% i = i+1 %>
      <%= link_to 'Rendre administrateur', user_add_administrator_path(@user), data: { confirm: "Etes-vous sûr de vouloir rendre #{@user.name} administrateur? Vous ne pourrez plus revenir en arrière!"}, :style => "color:red;" %>
    <% end %>
  </center>
<% end %>
