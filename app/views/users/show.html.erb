<% mois = ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"] %>

<% colors = ["#FFFFBB", "#FFBBBB", "#FFDD77", "#CCFFCC", "#CFF5FF", "#DDDDFF"] %>

<% provide(:title, @user.name) %>


<% if @user.admin %>
  <h1><%= @user.name %></h1>
  <b>Administrateur</b>
<% else %>


<% actualrating = @user.point.rating %>
<% niveau = @user.level %>

<h1 style="color:<%= niveau[:color] %>;"><%= @user.name %><span style="margin-left:30px;">-</span><span style="margin-left:30px;"><%= niveau[:name] %></span>
<% if current_user.sk.admin %>
<span style="color:<%= niveau[:color] %>; margin-left:100px; font-size:18px;">(<%= @user.email %><%= " - email non confirmé" if !@user.email_confirm %>)</span>
<% end %>
</h1>



  <div class="row">

  <div class="span6">
  <h2>Dernières résolutions</h2>
  <br/>
  <% exercises = @user.solvedexercises.where(:correct => true) %>
  <% qcms = @user.solvedqcms.where(:correct => true) %>
  <% problems = @user.solvedproblems %>
  <% activite = Array.new %>

  <% exercises.each do |e| %>
    <% pt = e.exercise.value %>
    <% pt = 0 if e.exercise.chapter.section.fondation %>
    <% activite.push({:time => e.updated_at, :type => 0, :pt => pt, :chapter => e.exercise.chapter.name}) %>
  <% end %>
  <% qcms.each do |q| %>
    <% pt = q.qcm.value %>
    <% pt = 0 if q.qcm.chapter.section.fondation %>
    <% activite.push({:time => q.updated_at, :type => 0, :pt => pt, :chapter => q.qcm.chapter.name}) %>
  <% end %>
  <% problems.each do |p| %>
    <% pt = p.problem.value %>
    <% pt = 0 if p.problem.chapter.section.fondation %>
    <% activite.push({:time => p.updated_at, :type => 1, :pt => pt, :chapter => p.problem.chapter.name}) %>
  <% end %>

  <% act = activite.sort{ |a, b| b[:time] <=> a[:time]} %>

  <% actperday = Array.new %>

  <% previousdate = Date.new(1980,1,1) %>
  <% encours = -1 %>

  <% parquoi = "" %>

  <% if act.size > 0 %>

    <% if act.last[:time].in_time_zone.day != DateTime.now.in_time_zone.day || act.last[:time].in_time_zone.month != DateTime.now.in_time_zone.month || act.last[:time].in_time_zone.year != DateTime.now.in_time_zone.year %>
      <% parquoi = "jour" %>
    <% elsif act.last[:time].in_time_zone.hour < act.first[:time].in_time_zone.hour - 1 %>
      <% parquoi = "heure" %>
    <% else %>
      <% parquoi = "minute" %>
    <% end %>

    <table class="table table-bordered">
    <tr><th style="width:140px;">Date</th><th style="width:50px;"><center>Heure</center></th><th style="width:70px;"><center>Type</center></th><th>Chapitre</th><th style="width:40px;"><center>Points</center></th></tr>
  <% end %>
  <% i = 1 %>
  <% act.each do |a| %>
    <% date = a[:time].in_time_zone %>

    <% if parquoi == "jour" %>
      <% dateday = DateTime.new(date.year, date.month, date.day, 0, 0) %>
    <% elsif parquoi == "heure" %>
      <% dateday = DateTime.new(date.year, date.month, date.day, date.hour, 0) %>
    <% else %>
      <% dateday = DateTime.new(date.year, date.month, date.day, date.hour, date.min) %>
    <% end %>

    <% if a[:pt] > 0 %>
      <% if dateday != previousdate %>
        <% encours = encours+1 %>
        <% actperday.push({:time => dateday, :pt => a[:pt], :chapter => a[:chapter]}) %>
      <% else %>
        <% actperday[encours][:pt] = actperday[encours][:pt] + a[:pt] %>
      <% end %>
      <% previousdate = dateday %>
    <% end %>

    <% if i <= 10 %>
    <tr style="background-color:<%= "#F1F1F1" if i % 2 == 1 %> <%= "white" if i % 2 == 0 %>;">
    <td><%= date.day %> <%= mois[date.month-1] %> <%= date.year %> </td><td><center> <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %></center></td>
    <td>
    <center>
    <% if a[:type] == 0 %>
      Exercice
    <% else %>
      Problème
    <% end %>
    </center>
    </td>
    <td>
      <%= a[:chapter] %>
    </td>
    <td>
    <center>
      <%= "+ #{a[:pt]}" if a[:pt] > 0 %>
    </center>
    </td>
    </tr>
    <% i = i+1 %>
    <% end %>
  <% end %>

  <% if act.size > 0 %>
    </table>
  <% else %>
    <b>Aucune activité.</b>
  <% end %>

  </div>

  <div class="span6">

  <center><p style="font-size:24px; margin-top:80px;">Score : <%= actualrating %></p></center>
  <br/>


  <% if actualrating > 0 %>

  <% p = Pointspersection.where(:user_id => @user) %>
  <% total = 0 %>
  <% possible2 = SortedSet.new %>

  <% Section.order(:id).where(:fondation => false).all.each do |s| %>
    <% rate = p.where(:section_id => s.id).first.points %>
    <% total = total + rate %>

    <% possible2.add([rate, s.name, s.id]) %>
  <% end %>

  <center>
  <canvas id="Camembert" width="240" height="240">
  Votre navigateur ne supporte pas les canvas.
  </canvas>
  </center>

  <center>
  <table class="table table-bordered" style="width:360px; margin-top:20px;">
  <% p = Pointspersection.where(:user_id => @user) %>
  <tr>
  <% i = 0 %>
  <% Section.order(:id).where(:fondation => false).all.each do |s| %>
    <% rate = p.where(:section_id => s.id).first.points %>

    <td style="width:180px; text-align:center; background-color:<%= colors[s.id-1] %>"><%= s.name %></td>
    <% i = i+1 %>
    <% if i == 2 || i == 4 %>
      </tr><tr>
    <% end %>

  <% end %>

  </tr>
  </table>
  </center>


  <script>
  var d=document.getElementById("Camembert");
  var ctx=d.getContext("2d");

  ctx.beginPath();
  ctx.arc(120, 120, 115, 0, 2 * Math.PI, false);
  ctx.fillStyle = 'white';
  ctx.fill();
  ctx.lineWidth = 2;
  ctx.strokeStyle = '#888888';
  ctx.stroke();
  prec = 0;
  <% while !possible2.empty? %>
    <% if (possible2.first)[0] > 0 %>
      ctx.beginPath();
      ctx.arc(120,120,115, prec, prec + (2 * Math.PI * <%= (possible2.first)[0] %>) / <%= total %>, false);
      prec = prec + (2 * Math.PI * <%= (possible2.first)[0] %>) / <%= total %>;
      ctx.lineTo(120, 120);
      ctx.closePath();
      ctx.fillStyle= "<%= colors[(possible2.first)[2]-1] %>";
      ctx.fill();
      ctx.lineWidth = 1;
      ctx.strokeStyle="#888888";
      ctx.stroke();
    <% end %>
    <% possible2.delete(possible2.first) %>
  <% end %>

  </script>

  <% end %>

  <% date = @user.created_at.in_time_zone %>
  <br/>
  <center>Inscription : <%= date.day %> <%= mois[date.month-1] %> <%= date.year %></center>

  </div>

  </div>


  <% if actualrating > 0 %>

  <div class="row">

  <div class="span12">

  <h2>Evolution</h2>
  <br/>
  <center>
  <div style="width:850px; height:500px; position:relative;">
  <canvas id="myCanvas" width="806" height="450" style="position:absolute; left:30px; top: 0px; border:1px solid #000000;">
  Votre navigateur ne supporte pas les canvas.
  </canvas>

  <% @niveaux = Color.order(:pt).all %>
  
  <% i = 1 %>
  <% numerolevel = 0 %>
  
  <% @niveaux.each do |n| %>
    <% if niveau.id == n.id %>
      <% numerolevel = i %>
    <% end %>
    <% i = i+1 %>
  <% end %>
  
  <% nombrelevel = i-1 %>
  
  <% maxi = 0 %>
  
  
  <% if numerolevel == nombrelevel %>
    <% maxi = 1.2*actualrating %>
  <% else %>
    <% maxi = 1.1*@niveaux[numerolevel][:pt] %>
  <% end %>
  
  <% i = 1 %>
  
  <% @niveaux.each do |n| %>
    <% if i > 1 %>
      <% haut = [450 - 450*(n.pt/maxi), 0].max %>
      <% if haut > 0 %>
        <div style="position:absolute; top:<%= haut-8 %>px; right:828px; width: 30px; text-align:right;"><%= n.pt %></div>
      <% end %>
    <% end %>
    <% i = i+1 %>
  <% end %>

  <% if actperday.size == 1 %>

  <% a = actperday.first %>

  <% if parquoi == "jour" %>
    <div style="position:absolute; top:460px; left:411px; width:44px; text-align:left; font-size:12px;"><%= "0" if a[:time].day < 10 %><%= a[:time].day %>/<%= "0" if a[:time].month < 10 %><%= a[:time].month %>/<%= "0" if (a[:time].year % 2000) < 10 %><%= (a[:time].year % 2000) %></div>
  <% elsif parquoi == "heure" %>
    <div style="position:absolute; top:460px; left:425px; width:44px; text-align:left; font-size:12px;"><%= "0" if a[:time].hour < 10 %><%= a[:time].hour %>h </div>
  <% else %>
    <div style="position:absolute; top:460px; left:418px; width:44px; text-align:left; font-size:12px;"><%= "0" if a[:time].hour < 10 %><%= a[:time].hour %>h<%= "0" if a[:time].min < 10 %><%= a[:time].min %></div>
  <% end %>

  <% else %>
    <% last = actperday.first[:time].to_time.to_i %>
    <% first = actperday.last[:time].to_time.to_i %>
    <% previousw = 2000 %>
    <% actperday.each do |a| %>
      <% w = 3 + 800*(a[:time].to_time.to_i - first)/(last-first) %>

      <% if previousw - w > 50 %>
        <% if parquoi == "jour" %>
          <div style="position:absolute; top:460px; left:<%= 8 + w %>px; width: 44px; text-align:left; font-size:12px;"><%= "0" if a[:time].day < 10 %><%= a[:time].day %>/<%= "0" if a[:time].month < 10 %><%= a[:time].month %>/<%= "0" if (a[:time].year % 2000) < 10 %><%= (a[:time].year % 2000) %></div>
        <% elsif parquoi == "heure" %>
          <div style="position:absolute; top:460px; left:<%= 22 + w %>px; width: 44px; text-align:left; font-size:12px;"><%= "0" if a[:time].hour < 10 %><%= a[:time].hour %>h </div>
        <% else %>
          <div style="position:absolute; top:460px; left:<%= 15 + w %>px; width: 44px; text-align:left; font-size:12px;"><%= "0" if a[:time].hour < 10 %><%= a[:time].hour %>h<%= "0" if a[:time].min < 10 %><%= a[:time].min %></div>
        <% end %>
        <% previousw = w %>
      <% end %>

    <% end %>
  <% end %>

  </div>
  </center>

  <script>
  var c=document.getElementById("myCanvas");
  var ctx=c.getContext("2d");
  
  <% i = 1 %>
  <% @niveaux.each do |n| %>
    <% if i == nombrelevel %>
      <% bas = [450 - 450*(n.pt/maxi) , 0].max %>
      <% haut = 0 %>
    <% else %>
      <% bas = [450 - 450*(n.pt/maxi), 0].max %>
      <% haut = [450 - 450*(@niveaux[i].pt/maxi), 0].max %>
    <% end %>
    <% if bas > haut %>
      ctx.beginPath();
      ctx.rect(0, <%= haut %>, 806, <%= bas - haut %>);
      ctx.fillStyle = '<%= n.font_color %>';
      ctx.fill();
    <% end %>
    <% i = i+1 %>
  <% end %>
  
  
  <% i = 1 %>
  <% @niveaux.each do |n| %>
    <% if i > 1 %>
      <% haut = [450 - 450*(n.pt/maxi), 0].max %>
      <% if haut > 0 %>
        ctx.beginPath();
        ctx.moveTo(0, <%= haut %>);
        ctx.lineTo(806, <%= haut %>);
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'white';
        ctx.stroke();
      <% end %>
    <% end %>
    <% i = i+1 %>
  <% end %>
  

  ctx.fillStyle = 'black';
  ctx.strokeStyle = 'black';

  <% if actperday.size == 1 %>
    <% (0..22).each do |i| %>
      ctx.moveTo(403, <%= 20*i %>);
      ctx.lineTo(403, <%= 20*i+10 %>);
      ctx.lineWidth = 1;
      ctx.strokeStyle = 'white';
      ctx.stroke();
    <% end %>
    ctx.beginPath();
    ctx.arc(403, <%= 450 - 450*(actualrating/maxi) %>, 3, 0, 2 * Math.PI, true);
    ctx.fill();
  <% else %>

    <% last = actperday.first[:time].to_time.to_i %>
    <% first = actperday.last[:time].to_time.to_i %>
    <% previousr = 0 %>
    <% prevw = -100 %>
    <% previousw = 2000 %>
    <% prevh = -1 %>

    <% actperday.each do |a| %>
      <% w = 3 + 800*(a[:time].to_time.to_i - first)/(last-first) %>
      <% if previousw - w > 50 %>
        ctx.beginPath();
        <% (0..22).each do |i| %>
          ctx.moveTo(<%= w %>, <%= 20*i %>);
          ctx.lineTo(<%= w %>, <%= 20*i+10 %>);
          ctx.lineWidth = 1;
          ctx.strokeStyle = 'white';
          ctx.stroke();
        <% end %>
        <% previousw = w %>
      <% end %>
    <% end %>

    <% actperday.reverse.each do |a| %>
      <% w = 3 + 800*(a[:time].to_time.to_i - first)/(last-first) %>
      <% r = previousr + a[:pt] %>
      <% previousr = r %>
      <% h = 450 - 450*(r/maxi) %>
      <% if prevw >= 0 %>
        ctx.beginPath();
        ctx.moveTo(<%= prevw %>, <%= prevh %>);
        ctx.lineTo(<%= w %>, <%= h %>);
        ctx.lineWidth = 2;
        ctx.strokeStyle = 'black';
        ctx.stroke();
      <% end %>
      ctx.beginPath();
      ctx.arc(<%= w %>, <%= h %>, 3, 0, 2 * Math.PI, true);
      ctx.fill();
      <% prevw = w %>
      <% prevh = h %>
    <% end %>
  <% end %>


  </script>

  </div>
  </div>

  <% end %>

  <% if current_user.sk.admin? %>
    <br/>
    <center>
      <%= link_to 'Supprimer cet utilisateur', @user, method: :delete, data: { confirm: "ATTENTION : Ne supprimez un utilisateur que s'il s'agit d'un robot ou d'une personne mal intentionnée. Cette action supprimera tous ses messages et toutes ses données. Etes-vous sûr de vouloir supprimer #{@user.name}?" } %>
      | <%= link_to 'Voir le site comme cet utilisateur', user_take_skin_path(@user), data: { confirm: "Vous allez voir tout le site comme #{@user.name} le voit." } %>
      <% if current_user.sk.root %>
        | <%= link_to 'Rendre administrateur', user_add_administrator_path(@user), data: { confirm: "Etes-vous sûr de vouloir rendre #{@user.name} administrateur? Vous ne pourrez plus revenir en arrière!"}, :style => "color:red;" %>
      <% end %>
    </center>
  <% end %>

<% end %>
