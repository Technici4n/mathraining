<% colors = ["#FFFFBB", "#FFBBBB", "#DDDDFF", "#CCFFCC"] %>
<% abreviation = ["C", "G", "TN", "A"] %>

<% provide(:title, 'Scores') %>
<h1>Scores</h1>



<% points = Point.order("rating DESC").where("rating != 0").all %>

<% allsec = Section.order(:id).all %>

<table class="table table-bordered" style="width:570px; margin-top:20px;">
  <tr><th style="width:20px;"></th><th style="width:200px;">Nom</th><th style="width:90px;"><center>Score</center></th><th style="width:260px;"><center>Préférences</center></th>
  </tr>
  <% rank = 1 %>
  <% points.each do |p| %>
    <% user = User.find(p.user) %>
    <% if !user.admin? %>
    
    <% niveau = user.level %>
    
    <tr style="background-color:<%= "#F1F1F1" if rank % 2 == 1 %> <%= "white" if rank % 2 == 0 %>;">
    <td><center><%= rank %></center></td>
    <td><b> <%= link_to user.name, user, {:style => "color:#{niveau[:color]}" } %> </b></td>
      
    <% rating = p.rating %>
    <td><center><%= rating %></center></td>
      
    <% p = Pointspersection.where(:user_id => user) %>
    <% total = 0 %>
    <% allsec.each do |s| %>
      <% rate = p.where(:section_id => s.id).first.points %>
      <% total = total + rate %>
    <% end %>
    
    <td>
    <center>
      <table style="height:20px; padding:0px; border:1px solid #CCCCCC;">
      <tr>
      <% allsec.each do |s| %>
        <% rate = p.where(:section_id => s.id).first.points %>
        <td style="padding:0px; text-align:center; width:<%= 220.0*rate/total %>px; background-color:<%= colors[s.id-1] %>">
        <%= abreviation[s.id-1] if 220.0*rate/total > 30 %>
        </td>
      <% end %>
      </tr>
      </table>
    </center>
    </td>
  
    </tr>
    <% rank = rank + 1  %>
    <% end %>
  <% end %>

</table>

<% if rank == 1 %>
  <b>Aucun utilisateur classé.</b>
<% end %>

<% if current_user.sk.root %>
<center>
<br/>
<%= link_to 'Recalculer tous les ratings', recompute_scores_path, data: { confirm: "Veillez à avoir une connexion stable et à ne pas interrompre l'opération (cela risque de durer un petit peu de temps)."}, :style => "color:red;" %>
<br/>
</center>
<% end %>

<% if current_user.sk.admin %>
<br/><center><b> --- Cette partie n'est visible que des administrateurs --- </b></center>
<h2>Utilisateurs non classés</h2>
<% points = Point.where(rating: 0).all %>
<% rank = 1 %>
<% points.each do |p| %>
  <% user = User.find(p.user) %>
  <% if !user.admin %>
    <b> <%= link_to user.name, user, {:style => "color:#{user.level[:color]}" } %> </b><br/>
    <% rank = rank + 1 %>
  <% end %>
<% end %>

<% if rank == 1 %>
  <b>Aucun utilisateur non classé.</b>
<% end %>

<h2>Administrateurs</h2>

<% User.where(:admin => true).each do |user| %>
  <% if user.admin %>
    <%= user.name %><br/>
  <% end %>
<% end %>

<% end %>

