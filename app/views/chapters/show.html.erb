<% provide(:title, @chapter.name) %>

<% if(params.has_key?:type) %>
<% type = params[:type].to_i %>
<% else type = 0 %>
<% end %>
<% if(params.has_key?:which) %>
<% id = params[:which].to_i %>
<% else id = 0 %>
<% end %>


<h1>
  <%= @chapter.name %> (niveau <%= @chapter.level %>)
</h1>

<div class="row">

  <div class="span2">
      <ul class="nav nav-list">
        <% number = 0 %>
        <% i = 1 %>
        <li class="nav-header">Préambule</li>
        <li<%= ' class="active"'.html_safe if type == 0 %>>
        <%= link_to "Introduction", chapter_path(@chapter) %></li>
        <li class="nav-header">Points théoriques</li>
        <% listex = @chapter.theories %>
        <% listex.sort!{|t1,t2|t1.position <=> t2.position} %>
        <% listex.each do |f| %>
          <li<%= ' class="active"'.html_safe if f.id == id && type == 1 %>>
          <%= link_to f.title, chapter_path(@chapter, :type => 1, :which => f.id) %></li>
          <% if f.id == id && type == 1 %>
            <% number = i %>
          <% end %>
          <% i = i + 1 %>
        <% end %>
        <li class="nav-header">Exercices</li>
        <% liste = @chapter.exercises %>
        <% liste.sort!{|t1,t2|t1.position <=> t2.position} %>
        <% liste2 = @chapter.qcms %>
        <% liste2.sort!{|t1,t2|t1.position <=> t2.position} %>
        <% un = 0 %>
        <% deux = 0 %>
        <% (1..(liste.size+liste2.size)).each do |i| %>
        
          <% encours = 0 %>
          <% if un >= liste.size %>
            <% encours = 2 %>
          <% else %>
            <% if deux >= liste2.size %>
              <% encours = 1 %>
            <% else %>
              <% if liste[un].position < liste2[deux].position %>
                <% encours = 1 %>
              <% else %>
                <% encours = 2 %>
              <% end %>
            <% end %>
          <% end %>
          
          <% if encours == 1 %>
            <% f = liste[un] %> 
            <li<%= ' class="active"'.html_safe if f.id == id && type == 2 %>>
            <%= link_to "Exercice #{i}", chapter_path(@chapter, :type => 2, :which => f.id) %></li>
            <% if f.id == id  && type == 2 %>
              <% number = i %>
            <% end %>
            <% un = un + 1 %>
          <% else %>
            <% f = liste2[deux] %> 
            <li<%= ' class="active"'.html_safe if f.id == id && type == 3 %>>
            <%= link_to "Exercice #{i}", chapter_path(@chapter, :type => 3, :which => f.id) %></li>
            <% if f.id == id  && type == 3 %>
              <% number = i %>
            <% end %>
            <% deux = deux + 1 %>
          <% end %>
          

        <% end %>
        <li class="nav-header">Problèmes</li>
        <% i = 1 %>
        <% listex = @chapter.problems %>
        <% listex.sort!{|t1,t2|t1.position <=> t2.position} %>
        <% listex.each do |f| %>
          <li<%= ' class="active"'.html_safe if f.id == id && type == 4 %>>
          <%= link_to f.name, chapter_path(@chapter, :type => 4, :which => f.id) %></li>
          <% if f.id == id && type == 4 %>
            <% number = i %>
          <% end %>
          <% i = i + 1 %>
        <% end %>
      </ul>
    </div>
    <div class="span10">
    
      <!-- INTRODUCTION -->
      
      <% if type == 0 %>
        <h3>Prérequis</h3>
        <% if @chapter.prerequisites.empty? %>
          <p>Aucun prérequis</p>
        <% else %>
          <ul>
            <% @chapter.prerequisites.order(:level).each do |prerequisite| %>
              <li><%= link_to prerequisite.name, prerequisite %></li>
            <% end %>
          </ul>
        <% end %>
        
        <center><%= link_to "Modifier les prérequis", graph_prerequisites_path(:fondement => 1) %></center>

        <h3>Introduction</h3>
        <p><%= @chapter.description %></p>
      
        <% if current_user.admin? %>
          <br/>
          <center>
          <%= link_to "Modifier le nom, le niveau ou l'introduction de ce chapitre", edit_chapter_path(@chapter) %> |

          <% if @chapter.sections.size > 1 %>
            <%= link_to "Supprimer ce chapitre", @chapter, method: :delete, data: { confirm: "Attention! En supprimant ce chapitre, vous le supprimerez des #{@chapter.sections.size} sections auxquelles il appartient! Etes-vous sûr de vouloir supprimer ce chapitre?" } %>
          <% else %>
            <%= link_to "Supprimer ce chapitre", @chapter, method: :delete, data: { confirm: "Etes-vous sûr de vouloir supprimer ce chapitre?" } %>
          <% end %> |

          <%= link_to "Ajouter ou retirer à une section", chapter_manage_sections_path(@chapter) %> <br/>
          </center>
        <% end %>
        
      <% end %>
      
      
      <!-- POINTS THEORIQUES -->
      
      <% if type == 1 && @chapter.theories.exists?(id)%>
        <% f = Theory.find(id) %>
        <h3><%= f.title %> </h3>
        <!--<%= simple_format f.content %>-->
        <%= markdown_render f.content %>
        <% if current_user.admin? %>
          <br/>
          <center>
          <%= link_to "Modifier ce point théorique", edit_theory_path(f) %> | 
          <%= link_to "Supprimer ce point théorique", f, method: :delete, data: { confirm: "Etes-vous sûr de vouloir supprimer ce point théorique?" } %>
          </center>
          <br/>
          
          <% if number > 1 %>
          <% up = true %>
          <% else %>
          <% up = false %>
          <% end %>
          
          <% if number < @chapter.theories.count %>
          <% down = true %>
          <% else %>
          <% down = false %>
          <% end %>
          
          <% if up || down %>
            <center>
            Déplacer ce point théorique vers le 
            <% if up %>
              <%= link_to "haut", theory_order_minus_path(f) %>
              <% if down %>
              | <%= link_to "bas", theory_order_plus_path(f) %>
              <% end %>
            <% else %>
              <%= link_to "bas", theory_order_plus_path(f) %>
            <% end %>
            </center> <br/>
          <% end %>
          
        <% end %>
        
      <% end %>
      
      
      <!-- EXERCICES -->
      
      <% if type == 2 && @chapter.exercises.exists?(id)%>
        <% f = Exercise.find(id) %>
        <h3>Exercice <%= number %></h3>
        <%= simple_format f.statement %>
        <br/>
        Réponse : 
        <% if f.decimal %>
          <%= f.answer %> (On demande une réponse décimale avec deux chiffres après la virgule)
        <% else %>
          <%= f.answer.to_i %> (On demande une réponse entière)
        <% end %>
        <br/>
        <% if current_user.admin? %>
          <br/>
          <center>
          <%= link_to "Modifier cet exercice", edit_exercise_path(f) %> | 
          <%= link_to "Supprimer cet exercice", f, method: :delete, data: { confirm: "Etes-vous sûr de vouloir supprimer cet exercice?" } %>
          </center>
          <br/>
          
          <% if number > 1 %>
          <% up = true %>
          <% else %>
          <% up = false %>
          <% end %>
          
          <% if number < liste.size + liste2.size %>
          <% down = true %>
          <% else %>
          <% down = false %>
          <% end %>
          
          <% if up || down %>
            <center>
            Déplacer cet exercice vers le 
            <% if up %>
              <%= link_to "haut", exercise_order_minus_path(f) %>
              <% if down %>
              | <%= link_to "bas", exercise_order_plus_path(f) %>
              <% end %>
            <% else %>
              <%= link_to "bas", exercise_order_plus_path(f) %>
            <% end %>
            </center> <br/>
          <% end %>
        <% end %>
        
      <% end %>

      
      
      <!-- QCMS -->
      
      <% if type == 3 && @chapter.qcms.exists?(id)%>
        <% f = Qcm.find(id) %>
        <h3>Exercice <%= number %></h3>
        <%= simple_format f.statement %>
        <br/>
        
        <table cellpadding="5">
        <tr><th></th><th></th><th>Rép?</th></tr>
        <% letters = ('A'..'Z').to_a %>
        <% i = 0 %>
        <% f.choices.order(:id).each do |c| %>
          <tr>
          <td>
          <%= letters[i] %>)
          </td>
          <td>
          <%= c.ans %>
          </td>
          <td>
          <center>
          <% if c.ok %>
            <i class="icon-ok"></i>
          <% else %>
            <i class="icon-remove"></i>
          <% end %>
          </center>
          </td>
          </tr>
          <% i = i+1 %>
        <% end %>

        </table>
        
        <% if f.many_answers %>
          (Plusieurs réponses possibles)
        <% else %>
          (Une seule réponse possible)
        <% end %>
        
        <br/>
        <% if current_user.admin? %>
          <br/>
          <center>
          <%= link_to "Modifier ce QCM", edit_qcm_path(f) %> | 
          <%= link_to "Modifier les réponses de ce QCM", qcm_manage_choices_path(f) %> | 
          <%= link_to "Supprimer ce QCM", f, method: :delete, data: { confirm: "Etes-vous sûr de vouloir supprimer ce QCM?" } %>
          </center>
          <br/>
          
          <% if number > 1 %>
          <% up = true %>
          <% else %>
          <% up = false %>
          <% end %>
          
          <% if number < liste.size + liste2.size %>
          <% down = true %>
          <% else %>
          <% down = false %>
          <% end %>
          
          <% if up || down %>
            <center>
            Déplacer ce QCM vers le 
            <% if up %>
              <%= link_to "haut", qcm_order_minus_path(f) %>
              <% if down %>
              | <%= link_to "bas", qcm_order_plus_path(f) %>
              <% end %>
            <% else %>
              <%= link_to "bas", qcm_order_plus_path(f) %>
            <% end %>
            </center> <br/>
          <% end %>
          
        <% end %>
        
      <% end %>
      
      
      
      
      
      <!-- PROBLEMES -->
      
      <% if type == 4 && @chapter.problems.exists?(id)%>
        <% f = Problem.find(id) %>
        <h3><%= f.name %> </h3>
        <%= simple_format f.statement%>
        <% if current_user.admin? %>
          <br/>
          <center>
          <%= link_to "Modifier ce problème", edit_problem_path(f) %> | 
          <%= link_to "Supprimer ce problème", f, method: :delete, data: { confirm: "Etes-vous sûr de vouloir supprimer ce problème?" } %>
          </center>
          <br/>
          
          <% if number > 1 %>
          <% up = true %>
          <% else %>
          <% up = false %>
          <% end %>
          
          <% if number < @chapter.problems.count %>
          <% down = true %>
          <% else %>
          <% down = false %>
          <% end %>
          
          <% if up || down %>
            <center>
            Déplacer ce problème vers le 
            <% if up %>
              <%= link_to "haut", problem_order_minus_path(f) %>
              <% if down %>
              | <%= link_to "bas", problem_order_plus_path(f) %>
              <% end %>
            <% else %>
              <%= link_to "bas", problem_order_plus_path(f) %>
            <% end %>
            </center> <br/>
          <% end %>
          
        <% end %>
        
      <% end %>
      
      
      
    
  </div>
</div>
<center>
  <% if current_user.admin? %>
    <br/>
    Ajouter un : 
    <%= link_to "point théorique", new_chapter_theory_path(@chapter) %> |
    <%= link_to "exercice", new_chapter_exercise_path(@chapter) %> |
    <%= link_to "QCM", new_chapter_qcm_path(@chapter) %> | 
    <%= link_to "problème", new_chapter_problem_path(@chapter) %>
  <% end %>
</center>
<br/>
<center>
  Retour à la section : 
  <% i = false %>
  <% @chapter.sections.each do |f| %>
    <% if i %> | <% end %>
    <%= link_to f.name, f %>
    <% i = true %>
  <% end %>
  <% if !i %>
    <%= link_to "Fondements", "../sections/0" %>
  <% end %>
</center>
