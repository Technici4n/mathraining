<% mois = ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"] %>

<% r = 0 %>
<% if(params.has_key?:r) %>
  <% r = params[:r].to_i %>
<% end %>

<% notif = current_user.sk.notifs.where(submission_id: @submission.id) %>
<% if notif.size > 0 && !current_user.other %>
  <% notif.first.delete %>
<% end %>

<h3>Soumission

<% case @submission.status %>
<% when 0 %>
  (en attente de correction)
<% when 1, 3 %>
  (erronée)
<% when 2 %>
  (correcte)
<% end %>
</h3>

<% if (@submission.status == 1 || @submission.status == 3) && !current_user.sk.admin %>
  Vous pouvez tenter de corriger cette solution en postant un commentaire, ou soumettre une nouvelle solution.
<% end %>

<table class="table table-bordered" style="margin-top:20px;">

<tr class="info hidden-xs">
<td style="font-size:20px; font-weight:bold; padding:10px; padding-left:15px; border-right:none;">
<% if @submission.user.admin %>
  <%= @submission.user.name %>
<% else %>
  <%= link_to @submission.user.name, @submission.user, {:style => "color:#{@submission.user.level[:color]}" } %>
<% end %>
</td>
<td style="vertical-align:middle; text-align:right; font-size:18px; padding-right:15px; border-left:none;">
<% date = @submission.created_at.in_time_zone %>
<%= date.day %> <%= mois[date.month-1] %> <%= date.year %> à <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %>
</td>
</tr>

<tr class="info visible-xs">
<td style="font-size:20px; font-weight:bold; padding:10px; padding-left:15px; border-right:none;">
<% if @submission.user.admin %>
  <%= @submission.user.name %>
<% else %>
  <%= link_to @submission.user.name, @submission.user, {:style => "color:#{@submission.user.level[:color]}" } %>
<% end %>
</td>
</tr>
<tr class="info visible-xs">
<td style="vertical-align:middle; text-align:right; font-size:18px; padding-right:15px; border-left:none;">
<% date = @submission.created_at.in_time_zone %>
<%= date.day %> <%= mois[date.month-1] %> <%= date.year %> à <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %>
</td>
</tr>

<tr><td colspan="2" style="padding:15px;">
<div>
<%= raw(bbcode(@submission.content)) %>
<% if @submission.submissionfiles.size + @submission.fakesubmissionfiles.size > 0 %>
  <% if @submission.submissionfiles.size + @submission.fakesubmissionfiles.size == 1 %>
    <br/><br/><b>1 pièce jointe :</b><br/>
  <% else %>
    <br/><br/><b><%= @submission.submissionfiles.size + @submission.fakesubmissionfiles.size %> pièces jointes :</b><br/>
  <% end %>
  <% @submission.submissionfiles.each do |f| %>
    <%= link_to f.file_file_name, download_submissionfile_path(f) %>
    <% if current_user.sk.root? %>
       - <%= link_to 'Supprimer le contenu', submissionfile_fake_delete_path(f), data: { confirm: "Vous vous apprêtez à supprimer le contenu de cette pièce jointe. Etes-vous sûr de vouloir continuer?"}, :style => "color:red;" %>
    <% end %>
    <br/>
  <% end %>
  <% @submission.fakesubmissionfiles.each do |f| %>
    <span style="color:#0000BB;"><%= f.file_file_name %> (désactivée)</span><br/>
  <% end %>
<% end %>
</div>
</td></tr>

</table>

<%= render 'corrections/index' %>

<% if current_user.sk.admin %>
  <% following = Following.find_by_user_id_and_submission_id(current_user.sk, @submission) %>
    <% if !following.nil? && following.read && @submission.status != 0 %>
      <center><%= link_to 'Marquer comme non lu', problem_submission_unread_path(@problem, @submission, :r => r), :class => "btn btn-default btn-grey" %></center>
    <% elsif !following.nil && @submission.status != 0 %>
      <center><%= link_to 'Marquer comme lu', problem_submission_read_path(@problem, @submission, :r => r), :class => "btn btn-default btn-grey" %></center>
    <% end %>
<% end %>

<% if current_user.sk.admin? || current_user.sk == @submission.user %>
  <%= render 'corrections/new' %>
<% end %>
