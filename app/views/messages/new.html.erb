<script type="text/javascript">
function showStuff(id) {
    document.getElementById("indice" + id).style.display = 'inline';
    document.getElementById("show" + id).style.display = 'none';
    document.getElementById("hide" + id).style.display = 'inline';
}
function hideStuff(id) {
    document.getElementById("indice" + id).style.display = 'none';
    document.getElementById("show" + id).style.display = 'inline';
    document.getElementById("hide" + id).style.display = 'none';
}
</script>

<% mois = ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"] %>
<% provide(:title, 'Répondre') %>

<% nb_indice = 0 %>

<% q = 0 %>
<% if(params.has_key?:q) %>
  <% q = params[:q].to_i %>
<% end %>

<% tot = @subject.messages.count %>
<% page = [0,((tot-1)/10).floor].max + 1 %>

<h1>
<span style="font-size:16px;"><%= link_to "Forum", subjects_path(:q => q) %> ></span>
<span style="font-size:24px;"><%= link_to @subject.title, subject_path(@subject, :anchor => "bottom", :page => page, :q => q) %> ></span>
Répondre
</h1>

<span style="color:red;">Veillez à ne dévoiler aucune solution à un exercice ou un problème. Si vous devez donner des éléments de solution pour expliquer un souci, écrivez-les en <i>texte caché</i>.</span><br/><br/>

<!-- Formulaire -->

<%= form_for [@subject, @message], :url => subject_messages_path(@subject, @message, :action => :create, :q => q), :html => { :multipart => true } do |f| %>
  <%= render 'form', f: f %>
  <span id="fooBar"></span>
  <input type="button" value="Ajouter une pièce jointe" onclick="Joint.add()"/>
  <br /><br/>
  <%= f.submit "Poster", class: "btn btn-lg btn-primary", :disabled => current_user.other %>
<% end %>

<!-- Messages récents -->
<h2>Messages récents</h2>

<% messages = @subject.messages.order("id DESC").slice(0,5) %>

<% messages.each do |m| %>

<!-- Messages -->
<table class="table table-bordered" style="margin-top:20px;">

<!-- Cas normal -->
<tr class="info hidden-xs">

<!-- Nom -->
<td style="font-size:20px; font-weight:bold; padding:10px; padding-left:15px; border-right:none;">
<% if m.user.admin %>
  <%= m.user.name %>
<% else %>
  <%= link_to m.user.name, m.user, {:style => "color:#{m.user.level[:color]}" } %>
<% end %>
</td>

<!-- Date -->
<td style="vertical-align:middle; text-align:right; font-size:20px; padding-right:15px; border-left:none;">
<% date = m.created_at.in_time_zone %>
<%= date.day %> <%= mois[date.month-1] %> <%= date.year %> à <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %>
</td>
</tr>

<!-- Cas gsm -->

<!-- Nom -->
<tr class="info visible-xs">
<td style="font-size:20px; font-weight:bold; padding:10px; padding-left:15px; border-right:none;">
<% if m.user.admin %>
  <%= m.user.name %>
<% else %>
  <%= link_to m.user.name, m.user, {:style => "color:#{m.user.level[:color]}" } %>
<% end %>
</td>
</tr>

<!-- Date -->
<tr class="info visible-xs">
<td style="vertical-align:middle; text-align:right; font-size:20px; padding-right:15px; border-left:none;">
<% date = m.created_at.in_time_zone %>
<%= date.day %> <%= mois[date.month-1] %> <%= date.year %> à <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %>
</td>
</tr>

<!-- Contenu du message -->
<tr><td colspan="2" style="padding:15px;">
<div>
<% bb = bbcode(m.content) %>
<% while bb.sub!(/\[hide=(?:&quot;)?(.*?)(?:&quot;)?\](.*?)\[\/hide\]/mi) {"<div style='background-color:#FFFFCC; margin-top:10px; border:1px solid orange; padding:10px;'><a href='#' id='show#{nb_indice}' onclick='showStuff(#{nb_indice}); return false;' style='display:inline;' class='btn btn-default btn-grey'>#{$1}</a><a href='#' id='hide#{nb_indice}' style='display:none;' class='btn btn-default btn-grey' onclick='hideStuff(#{nb_indice}); return false;'>#{$1}</a><span id='indice#{nb_indice}' style='display:none;'><br/><br/>#{$2}</span></div>"} %>
<% nb_indice = nb_indice+1 %>
<% end %>
<%= raw(bb) %>

<!-- Pièces jointes -->
<% if m.messagefiles.size > 0 %>
  <% if m.messagefiles.size == 1 %>
    <br/><br/><b>1 pièce jointe.</b>
  <% else %>
    <br/><br/><b><%= m.messagefiles.size %> pièces jointes.</b>
  <% end %>
<% end %>
</div>
</td></tr>

</table>

<% end %>

<!-- Si moins de 5 messages, on affiche le sujet également -->

<% if messages.size < 5 %>

<table class="table table-bordered" style="margin-top:20px;">

<!-- Cas normal -->
<tr class="info hidden-xs">

<!-- Nom -->
<td style="font-size:20px; font-weight:bold; padding:10px; padding-left:15px; border-right:none;">
<% if @subject.user.admin %>
  <%= @subject.user.name %>
<% else %>
  <%= link_to @subject.user.name, @subject.user, {:style => "color:#{@subject.user.level[:color]}" } %>
<% end %>
</td>

<!-- Date -->
<td style="vertical-align:middle; text-align:right; font-size:20px; padding-right:15px; border-left:none;">
<% date = @subject.created_at.in_time_zone %>
<%= date.day %> <%= mois[date.month-1] %> <%= date.year %> à <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %>
</td>
</tr>

<!-- Cas gsm -->

<!-- Nom -->
<tr class="info visible-xs">
<td style="font-size:20px; font-weight:bold; padding:10px; padding-left:15px; border-right:none;">
<% if @subject.user.admin %>
  <%= @subject.user.name %>
<% else %>
  <%= link_to @subject.user.name, @subject.user, {:style => "color:#{@subject.user.level[:color]}" } %>
<% end %>
</td>
</tr>

<!-- Date -->
<tr class="info visible-xs">
<td style="vertical-align:middle; text-align:right; font-size:20px; padding-right:15px; border-left:none;">
<% date = @subject.created_at.in_time_zone %>
<%= date.day %> <%= mois[date.month-1] %> <%= date.year %> à <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %>
</td>
</tr>

<!-- Contenu du sujet -->
<tr><td colspan="2" style="padding:15px;">
<div>
<% bb = bbcode(@subject.content) %>
<% while bb.sub!(/\[hide=(?:&quot;)?(.*?)(?:&quot;)?\](.*?)\[\/hide\]/mi) {"<div style='background-color:#FFFFCC; margin-top:10px; border:1px solid orange; padding:10px;'><a href='#' id='show#{nb_indice}' onclick='showStuff(#{nb_indice}); return false;' style='display:inline;' class='btn btn-default btn-grey'>#{$1}</a><a href='#' id='hide#{nb_indice}' style='display:none;' class='btn btn-default btn-grey' onclick='hideStuff(#{nb_indice}); return false;'>#{$1}</a><span id='indice#{nb_indice}' style='display:none;'><br/><br/>#{$2}</span></div>"} %>
<% nb_indice = nb_indice+1 %>
<% end %>
<%= raw(bb) %>

<!-- Pièces jointes -->
<% if @subject.subjectfiles.size > 0 %>
  <% if @subject.subjectfiles.size == 1 %>
    <br/><br/><b>1 pièce jointe.</b>
  <% else %>
    <br/><br/><b><%= @subject.subjectfiles.size %> pièces jointes.</b>
  <% end %>
<% end %>
</div>
</td></tr>

</table>

<% end %>

<script>
PreviewSafe.Init();
PreviewSafe.Update();
</script>
