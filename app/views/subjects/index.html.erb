<% mois = ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"] %>
<% provide(:title, 'Forum') %>

<% def affiche_date(date, datenow) %>
  <% mois = ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"] %>
  
  <% if (datenow - date).floor >= 24*60*60 %>
    <%= date.day %> <%= mois[date.month-1] %> <%= date.year %> à <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %>
  <% elsif (datenow - date).floor >= 60*60 %>
    <% minute = ((datenow - date)/60).floor %>
    <% heure = (minute / 60).floor %>
    <% minute = minute - 60*heure %>
    il y a <%= heure %> heure<%="s" if heure > 1 %>, <%= minute %> minute<%= "s" if minute > 1 %>
  <% elsif (datenow - date).floor >= 60 %>
    <% minute = ((datenow - date)/60).floor %>
    il y a <%= minute %> minute<%= "s" if minute > 1 %>
  <% else %>
    <% seconde = (datenow - date).floor %>
    il y a <%= seconde %> seconde<%= "s" if seconde > 1 %>
  <% end %>
<% end %>

<h1>Forum <%= @bonjour %>
<% unless @chapter.nil? %>
   - <%= @chapter.name %>
<% end %>
</h1>

<% if @importants.size > 0 %>

<table class="table table-bordered" style="margin-top:20px;">
  <tr class="error" style="font-weight:bold;">
    <td style="text-align:center;">Sujet important</td>
    <td style="width:180px; text-align:center;">Auteur</td>
    <td style="width:50px; text-align:center;">Rép.</td>
    <td style="text-align:center;" colspan="2">Dernière contribution</td></tr>
  <% @importants.each do |s| %>
    <tr>
      <td>
        <% if s.admin? %>
          <span class="label label-warning">Admin</span> - 
        <% end %>
        <% if @chapter.nil? %>
          <%= link_to s.title, s %>
          <% if @chapter.nil? and not s.chapter.nil? %>
            - <%= s.chapter.name %>
          <% end %>
        <% else %>
          <%= link_to s.title, chapter_subject_path(@chapter, s) %>
          <% if @chapter.nil? and not s.chapter.nil? %>
            - <%= s.chapter.name %>
          <% end %>
        <% end %>
      </td>
      <td style="text-align:center; font-weight:bold;">
      	<% if s.user.admin %>
          <%= s.user.name %>
        <% else %>
          <%= link_to s.user.name, s.user, {:style => "color:#{s.user.level[:color]}" } %>
        <% end %>
      </td>
      <td style="text-align:center;">
        <%= x = s.messages.count %>
      </td>
        <% if x > 0 %>
          <% last = s.messages.order(:id).last %>
          <% qui = last.user %>
          <% date = last.created_at.in_time_zone %>
        <% else %>
          <% qui = s.user %>
          <% date = s.created_at.in_time_zone %>
        <% end %>
        
        <% datenow = Time.zone.now %>
        
      <td style="width:180px; text-align:center; font-weight:bold;">
        <% if qui.admin %>
          <%= qui.name %>
        <% else %>
          <%= link_to qui.name, qui, {:style => "color:#{qui.level[:color]}" } %>
        <% end %>
      </td>
      <td style="width:180px; text-align:center;">
        <% tot = s.messages.count %>
        <% page = [0,((tot-1)/10).floor].max + 1 %>
        <% if @chapter.nil? %>
          <%= link_to subject_path(s, :page => page, :anchor => "bottom") do %>
            <% affiche_date(date, datenow) %>
          <% end %>
        <% else %>
          <%= link_to chapter_subject_path(@chapter, s, :page => page, :anchor => "bottom") do %>
            <% affiche_date(date, datenow) %>
          <% end %>
        <% end %>
      </td>
    </tr>
  <% end %>

</table>

<% end %>

<% if @subjects.size > 0 %>

<table class="table table-bordered" style="margin-top:20px;">
  <tr class="info" style="font-weight:bold;">
    <td style="text-align:center;">Sujet</td>
    <td style="width:180px; text-align:center;">Auteur</td>
    <td style="width:50px; text-align:center;">Rép.</td>
    <td style="text-align:center;" colspan="2">Dernière contribution</td></tr>
  <% @subjects.each do |s| %>
    <tr>
      <td>
        <% if s.admin? %>
          <span class="label label-warning">Admin</span> - 
        <% end %>
        <% if @chapter.nil? %>
          <%= link_to s.title, s %>
          <% if @chapter.nil? and not s.chapter.nil? %>
            - <%= s.chapter.name %>
          <% end %>
        <% else %>
          <%= link_to s.title, chapter_subject_path(@chapter, s) %>
          <% if @chapter.nil? and not s.chapter.nil? %>
            - <%= s.chapter.name %>
          <% end %>
        <% end %>
      </td>
      <td style="text-align:center; font-weight:bold;">
        <% if s.user.admin %>
          <%= s.user.name %>
        <% else %>
          <%= link_to s.user.name, s.user, {:style => "color:#{s.user.level[:color]}" } %>
        <% end %>
      </td>
      <td style="text-align:center;">
        <%= x = s.messages.count %>
      </td>
        <% if x > 0 %>
          <% last = s.messages.order(:id).last %>
          <% qui = last.user %>
          <% date = last.created_at.in_time_zone %>
        <% else %>
          <% qui = s.user %>
          <% date = s.created_at.in_time_zone %>
        <% end %>
        
        <% datenow = Time.zone.now %>
        
      <td style="width:180px; text-align:center; font-weight:bold;">
        <% if qui.admin %>
          <%= qui.name %>
        <% else %>
          <%= link_to qui.name, qui, {:style => "color:#{qui.level[:color]}" } %>
        <% end %>
      </td>
      <td style="width:180px; text-align:center;">
        <% tot = s.messages.count %>
        <% page = [0,((tot-1)/10).floor].max + 1 %>
        <% if @chapter.nil? %>
          <%= link_to subject_path(s, :page => page, :anchor => "bottom") do %>
            <% affiche_date(date, datenow) %>
          <% end %>
        <% else %>
          <%= link_to chapter_subject_path(@chapter, s, :page => page, :anchor => "bottom") do %>
            <% affiche_date(date, datenow) %>
          <% end %>
        <% end %>
      </td>
    </tr>
  <% end %>

</table>

<% end %>

<center><%= will_paginate @subjects %></center>

<% if @subjects.size + @importants.size == 0 %>
<b>Aucun sujet</b>
<% end %>

<center>
  <br/>
  <% if @chapter.nil? %>
    <%= link_to "Créer un sujet", new_subject_path, class: 'btn btn-large' %>
  <% else %>
    <%= link_to "Créer un sujet", new_chapter_subject_path(@chapter), class: 'btn btn-large' %>
  <% end %>
</center>

