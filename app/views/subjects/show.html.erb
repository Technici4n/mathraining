<% mois = ["janvier", "février", "mars", "avril", "mai", "juin", "juillet", "août", "septembre", "octobre", "novembre", "décembre"] %>

<% provide(:title, @subject.title.html_safe) %>

<% q = 0 %>
<% if(params.has_key?:q) %>
  <% q = params[:q].to_i %>
<% end %>

<h1 style="margin-bottom:15px;">
<table>
<tr>
<td nowrap style="vertical-align:top;">
<span style="font-size:16px;"><%= link_to "Forum", subjects_path(:q => q) %> ></span>
</td>
<td style="padding-left:10px; vertical-align:top;">
<%= @subject.title %>
<% if !@subject.chapter.nil? %>
  <% @chapitre = @subject.chapter %>
   - <%= @chapitre.name %>
<% end %>
</td>
</tr>
</table>
</h1>




<% if @subject.admin? %>
<br/><center><span class="label label-warning">Sujet réservé aux administrateurs</span></center><br/>
<% end %>

<center>
<%= will_paginate @messages, :style => "margin-top:-10px;", :class => "hidden-xs" %>
<%= will_paginate @messages, :style => "margin-top:-10px;", :class => "visible-xs", :previous_label => "Préc.", :next_label => "Suiv." %>
</center>

<% ouonest = 0 %>

<% if ((!params.has_key?:page) || (params[:page] == '1')) %>
<% ouonest = ouonest+1 %>
<table class="table table-bordered">

<tr class="hidden-xs info">
<td style="font-size:20px; font-weight:bold; padding:10px; padding-left:15px; border-right:none;">
<% if @subject.user.admin %>
  <%= @subject.user.name %>
<% else %>
  <%= link_to @subject.user.name, @subject.user, {:style => "color:#{@subject.user.level[:color]}" } %>
<% end %>
</td>
<td style="vertical-align:middle; text-align:right; font-size:20px; padding-right:15px; border-left:none;">
<% date = @subject.created_at.in_time_zone %>
<%= date.day %> <%= mois[date.month-1] %> <%= date.year %> à <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %>
</td>
</tr>

<tr class="visible-xs info">
<td style="font-size:20px; font-weight:bold; padding:10px; padding-left:15px; border-right:none;">
<% if @subject.user.admin %>
  <%= @subject.user.name %>
<% else %>
  <%= link_to @subject.user.name, @subject.user, {:style => "color:#{@subject.user.level[:color]}" } %>
<% end %>
</td>
</tr>
<tr class="visible-xs info">
<td style="vertical-align:middle; text-align:right; font-size:20px; padding-right:15px; border-left:none;">
<% date = @subject.created_at.in_time_zone %>
<%= date.day %> <%= mois[date.month-1] %> <%= date.year %> à <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %>
</td>
</tr>

<tr><td colspan="2" style="padding:15px;">
<div>
<% if @subject.admin_user? %>
<%= raw(@subject.content.gsub(/<hr>[ \r]*\n/,'<hr>').gsub(/\\][ \r]*\n/,'\] ').gsub(/\$\$[ \r]*\n/,'$$ ').gsub(/<\/h2>[ \r]*\n/,'</h2>').gsub(/<\/h3>[ \r]*\n/,'</h3>').gsub(/<\/h4>[ \r]*\n/,'</h4>').gsub(/<\/ol>[ \r]*\n/, '</ol>').gsub(/\n[ \r]*<\/ol>/, '</ol>').gsub(/<\/ul>[ \r]*\n/, '</ul>').gsub(/\n[ \r]*<\/ul>/, '</ul>').gsub(/\n[ \r]*<li>/, '<li>').gsub(/\n/, '<br/>')) %>
<% else %>
<%= raw((h @subject.content.gsub(/\\][ \r]*\n/,'\] ').gsub(/\$\$[ \r]*\n/,'$$ ')).gsub(/\n/, '<br>')) %>
<% end %>
<% if @subject.subjectfiles.size + @subject.fakesubjectfiles.size > 0 %>
  <% if @subject.subjectfiles.size + @subject.fakesubjectfiles.size == 1 %>
    <br/><br/><b>1 pièce jointe :</b><br/>
  <% else %>
    <br/><br/><b><%= @subject.subjectfiles.size + @subject.fakesubjectfiles.size %> pièces jointes :</b><br/>
  <% end %>
  <% @subject.subjectfiles.each do |f| %>
    <%= link_to f.file_file_name, download_subjectfile_path(f) %>
    <% if signed_in? && current_user.sk.root? %>
       - <%= link_to 'Supprimer le contenu', subjectfile_fake_delete_path(f), data: { confirm: "Vous vous apprêtez à supprimer le contenu de cette pièce jointe. Etes-vous sûr de vouloir continuer?"}, :style => "color:red;" %>
    <% end %>
    <br/>
  <% end %>
  <% @subject.fakesubjectfiles.each do |f| %>
    <span style="color:#0000BB;"><%= f.file_file_name %> (désactivée)</span><br/>
  <% end %>
<% end %>
</div>
</td></tr>

<% if signed_in? && (@subject.user == current_user.sk || (current_user.sk.admin && !@subject.user.admin) || current_user.sk.root) %>
  <tr><td colspan="2">
  <center>
      <%= link_to "Modifier ce sujet", edit_subject_path(@subject, :q => q) %>
      <% if current_user.sk.admin? %>
        | <%= link_to "Supprimer ce sujet", subject_path(@subject), method: :delete, data: { confirm: "Etes-vous sûr de vouloir supprimer ce sujet et tous les messages qui vont avec ?" }  %>
      <% end %>
  </center>
  </td></tr>
<% end %>

</table>

<% end %>

<% @messages.each do |m| %>
<a name="<%= m.id %>"></a>
<% ouonest = ouonest+1 %>
<table class="table table-bordered" style="<%= 'margin-top:20px;' if ouonest > 1 %>">

<tr class="hidden-xs info">
<td style="font-size:20px; font-weight:bold; padding:10px; padding-left:15px; border-right:none;">
<% if m.user.admin %>
  <%= m.user.name %>
<% else %>
  <%= link_to m.user.name, m.user, {:style => "color:#{m.user.level[:color]}" } %>
<% end %>
</td>
<td style="vertical-align:middle; text-align:right; font-size:20px; padding-right:15px; border-left:none;">
<% date = m.created_at.in_time_zone %>
<%= date.day %> <%= mois[date.month-1] %> <%= date.year %> à <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %>
</td>
</tr>

<tr class="visible-xs info">
<td style="font-size:20px; font-weight:bold; padding:10px; padding-left:15px; border-right:none;">
<% if m.user.admin %>
  <%= m.user.name %>
<% else %>
  <%= link_to m.user.name, m.user, {:style => "color:#{m.user.level[:color]}" } %>
<% end %>
</td>
</tr>
<tr class="visible-xs info">
<td style="vertical-align:middle; text-align:right; font-size:20px; padding-right:15px; border-left:none;">
<% date = m.created_at.in_time_zone %>
<%= date.day %> <%= mois[date.month-1] %> <%= date.year %> à <%= date.hour %>h<%= "0" if date.min < 10 %><%= date.min %>
</td>
</tr>

<tr><td colspan="2" style="padding:15px;">
<div>
<% if m.admin_user? %>
<%= raw(m.content.gsub(/<hr>[ \r]*\n/,'<hr>').gsub(/\\][ \r]*\n/,'\] ').gsub(/\$\$[ \r]*\n/,'$$ ').gsub(/<\/h2>[ \r]*\n/,'</h2>').gsub(/<\/h3>[ \r]*\n/,'</h3>').gsub(/<\/h4>[ \r]*\n/,'</h4>').gsub(/<\/ol>[ \r]*\n/, '</ol>').gsub(/\n[ \r]*<\/ol>/, '</ol>').gsub(/<\/ul>[ \r]*\n/, '</ul>').gsub(/\n[ \r]*<\/ul>/, '</ul>').gsub(/\n[ \r]*<li>/, '<li>').gsub(/\n/, '<br/>')) %>
<% else %>
<%= raw((h m.content.gsub(/\\][ \r]*\n/,'\] ').gsub(/\$\$[ \r]*\n/,'$$ ')).gsub(/\n/, '<br>')) %>
<% end %>
<% if m.messagefiles.size + m.fakemessagefiles.size > 0 %>
  <% if m.messagefiles.size + m.fakemessagefiles.size == 1 %>
    <br/><br/><b>1 pièce jointe :</b><br/>
  <% else %>
    <br/><br/><b><%= m.messagefiles.size + m.fakemessagefiles.size %> pièces jointes :</b><br/>
  <% end %>
  <% m.messagefiles.each do |f| %>
    <%= link_to f.file_file_name, download_messagefile_path(f) %>
    <% if current_user.sk.root? %>
       - <%= link_to 'Supprimer le contenu', messagefile_fake_delete_path(f), data: { confirm: "Vous vous apprêtez à supprimer le contenu de cette pièce jointe. Etes-vous sûr de vouloir continuer?"}, :style => "color:red;" %>
    <% end %>
    <br/>
  <% end %>
  <% m.fakemessagefiles.each do |f| %>
    <span style="color:#0000BB;"><%= f.file_file_name %> (désactivée)</span><br/>
  <% end %>
<% end %>
</div>
</td></tr>

<% if signed_in? && (m.user == current_user.sk || (current_user.sk.admin && !m.user.admin) || current_user.sk.root) %>
  <tr><td colspan="2">
  <center>
      <%= link_to "Modifier ce message", edit_subject_message_path(@subject, m, :q => q) %>
      <% if current_user.sk.admin? %>
         | <%= link_to "Supprimer ce message", subject_message_path(@subject, m), method: :delete, data: { confirm: "Etes-vous sûr de vouloir supprimer ce message ?" }  %>
      <% end %>
  </center>
  </td></tr>
<% end %>

</table>
<% end %>

<center>
<%= will_paginate @messages, :style => "margin-top:-10px;", :class => "hidden-xs" %>
<%= will_paginate @messages, :style => "margin-top:-10px;", :class => "visible-xs", :previous_label => "Préc.", :next_label => "Suiv." %>
</center>

<center>
<% if signed_in? %>
  <%= link_to "Répondre", new_subject_message_path(@subject, :q => q), class: 'btn btn-lg btn-default btn-grey' %>
<% else %>
  <button type=button disabled=true class="btn btn-lg btn-default btn-grey">Répondre</button>
<% end %>
</center>

<hr style="border-top:1px lightgray dashed;" />

<% if !signed_in? %>
  <center><button type=button disabled=true class="btn btn-default btn-grey">Suivre ce sujet</button></center>
  <hr style="border-top:1px dashed lightgray;" />
  <center>Pour pouvoir répondre à ce sujet ou le suivre, vous devez être connecté.</center>
<% elsif !current_user.followed_subjects.exists?(@subject) %>
  <center><%= link_to "Suivre ce sujet", add_followingsubject_path(:subject_id => @subject.id), data: { confirm: "Vous recevrez un email à chaque fois qu'un nouveau message sera posté sur ce sujet."}, class: 'btn btn-default btn-grey' %></center>
<% else %>
  <center><%= link_to "Ne plus suivre ce sujet", remove_followingsubject_path(:subject_id => @subject.id), class: 'btn btn-default btn-grey' %></center>
<% end %>

<a name="bottom"></a>
