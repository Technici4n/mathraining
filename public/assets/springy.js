/**
 * Springy v1.2.0
 *
 * Copyright (c) 2010 Dennis Hotson
 *
 * Permission is hereby granted, free of charge, to any person
 * obtaining a copy of this software and associated documentation
 * files (the "Software"), to deal in the Software without
 * restriction, including without limitation the rights to use,
 * copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following
 * conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 * OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 * HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 * WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 * OTHER DEALINGS IN THE SOFTWARE.
 */
// Enable strict mode for EC5 compatible browsers
"use strict";function Renderer(e,t,n,r){this.layout=e,this.clear=t,this.drawEdge=n,this.drawNode=r,this.layout.graph.addGraphListener(this)}var Graph=function(){this.nodeSet={},this.nodes=[],this.edges=[],this.adjacency={},this.nextNodeId=0,this.nextEdgeId=0,this.eventListeners=[]},Node=function(e,t){this.id=e,this.data=t!==undefined?t:{}},Edge=function(e,t,n,r){this.id=e,this.source=t,this.target=n,this.data=r!==undefined?r:{}};Graph.prototype.addNode=function(e){return e.id in this.nodeSet||this.nodes.push(e),this.nodeSet[e.id]=e,this.notify(),e},Graph.prototype.addNodes=function(){for(var e=0;e<arguments.length;e++){var t=arguments[e],n=new Node(t,{label:t});this.addNode(n)}},Graph.prototype.addEdge=function(e){var t=!1;return this.edges.forEach(function(n){e.id===n.id&&(t=!0)}),t||this.edges.push(e),e.source.id in this.adjacency||(this.adjacency[e.source.id]={}),e.target.id in this.adjacency[e.source.id]||(this.adjacency[e.source.id][e.target.id]=[]),t=!1,this.adjacency[e.source.id][e.target.id].forEach(function(n){e.id===n.id&&(t=!0)}),t||this.adjacency[e.source.id][e.target.id].push(e),this.notify(),e},Graph.prototype.addEdges=function(){for(var e=0;e<arguments.length;e++){var t=arguments[e],n=this.nodeSet[t[0]];if(n==undefined)throw new TypeError("invalid node name: "+t[0]);var r=this.nodeSet[t[1]];if(r==undefined)throw new TypeError("invalid node name: "+t[1]);var i=t[2];this.newEdge(n,r,i)}},Graph.prototype.newNode=function(e){var t=new Node(this.nextNodeId++,e);return this.addNode(t),t},Graph.prototype.newEdge=function(e,t,n){var r=new Edge(this.nextEdgeId++,e,t,n);return this.addEdge(r),r},Graph.prototype.loadJSON=function(e){if(typeof e=="string"||e instanceof String)e=JSON.parse(e);if("nodes"in e||"edges"in e)this.addNodes.apply(this,e.nodes),this.addEdges.apply(this,e.edges)},Graph.prototype.getEdges=function(e,t){return e.id in this.adjacency&&t.id in this.adjacency[e.id]?this.adjacency[e.id][t.id]:[]},Graph.prototype.removeNode=function(e){e.id in this.nodeSet&&delete this.nodeSet[e.id];for(var t=this.nodes.length-1;t>=0;t--)this.nodes[t].id===e.id&&this.nodes.splice(t,1);this.detachNode(e)},Graph.prototype.detachNode=function(e){var t=this.edges.slice();t.forEach(function(t){(t.source.id===e.id||t.target.id===e.id)&&this.removeEdge(t)},this),this.notify()},Graph.prototype.removeEdge=function(e){for(var t=this.edges.length-1;t>=0;t--)this.edges[t].id===e.id&&this.edges.splice(t,1);for(var n in this.adjacency)for(var r in this.adjacency[n]){var i=this.adjacency[n][r];for(var s=i.length-1;s>=0;s--)this.adjacency[n][r][s].id===e.id&&this.adjacency[n][r].splice(s,1)}this.notify()},Graph.prototype.merge=function(e){var t=[];e.nodes.forEach(function(e){t.push(this.addNode(new Node(e.id,e.data)))},this),e.edges.forEach(function(e){var n=t[e.from],r=t[e.to],i=e.directed?i=e.type+"-"+n.id+"-"+r.id:n.id<r.id?e.type+"-"+n.id+"-"+r.id:e.type+"-"+r.id+"-"+n.id,s=this.addEdge(new Edge(i,n,r,e.data));s.data.type=e.type},this)},Graph.prototype.filterNodes=function(e){var t=this.nodes.slice();t.forEach(function(t){e(t)||this.removeNode(t)},this)},Graph.prototype.filterEdges=function(e){var t=this.edges.slice();t.forEach(function(t){e(t)||this.removeEdge(t)},this)},Graph.prototype.addGraphListener=function(e){this.eventListeners.push(e)},Graph.prototype.notify=function(){this.eventListeners.forEach(function(e){e.graphChanged()})};var Layout={};Layout.ForceDirected=function(e,t,n,r){this.graph=e,this.stiffness=t,this.repulsion=n,this.damping=r,this.nodePoints={},this.edgeSprings={}},Layout.ForceDirected.prototype.point=function(e){if(!(e.id in this.nodePoints)){var t=e.data.mass!==undefined?e.data.mass:1;this.nodePoints[e.id]=new Layout.ForceDirected.Point(Vector.random(),t)}return this.nodePoints[e.id]},Layout.ForceDirected.prototype.spring=function(e){if(!(e.id in this.edgeSprings)){var t=e.data.length!==undefined?e.data.length:1,n=!1,r=this.graph.getEdges(e.source,e.target);r.forEach(function(e){n===!1&&e.id in this.edgeSprings&&(n=this.edgeSprings[e.id])},this);if(n!==!1)return new Layout.ForceDirected.Spring(n.point1,n.point2,0,0);var i=this.graph.getEdges(e.target,e.source);r.forEach(function(e){n===!1&&e.id in this.edgeSprings&&(n=this.edgeSprings[e.id])},this);if(n!==!1)return new Layout.ForceDirected.Spring(n.point2,n.point1,0,0);this.edgeSprings[e.id]=new Layout.ForceDirected.Spring(this.point(e.source),this.point(e.target),t,this.stiffness)}return this.edgeSprings[e.id]},Layout.ForceDirected.prototype.eachNode=function(e){var t=this;this.graph.nodes.forEach(function(n){e.call(t,n,t.point(n))})},Layout.ForceDirected.prototype.eachEdge=function(e){var t=this;this.graph.edges.forEach(function(n){e.call(t,n,t.spring(n))})},Layout.ForceDirected.prototype.eachSpring=function(e){var t=this;this.graph.edges.forEach(function(n){e.call(t,t.spring(n))})},Layout.ForceDirected.prototype.applyCoulombsLaw=function(){this.eachNode(function(e,t){this.eachNode(function(e,n){if(t!==n){var r=t.p.subtract(n.p),i=r.magnitude()+.1,s=r.normalise();t.applyForce(s.multiply(this.repulsion).divide(i*i*.5)),n.applyForce(s.multiply(this.repulsion).divide(i*i*-0.5))}})})},Layout.ForceDirected.prototype.applyHookesLaw=function(){this.eachSpring(function(e){var t=e.point2.p.subtract(e.point1.p),n=e.length-t.magnitude(),r=t.normalise();e.point1.applyForce(r.multiply(e.k*n*-0.5)),e.point2.applyForce(r.multiply(e.k*n*.5))})},Layout.ForceDirected.prototype.attractToCentre=function(){this.eachNode(function(e,t){var n=t.p.multiply(-1);t.applyForce(n.multiply(this.repulsion/50))})},Layout.ForceDirected.prototype.updateVelocity=function(e){this.eachNode(function(t,n){n.v=n.v.add(n.a.multiply(e)).multiply(this.damping),n.a=new Vector(0,0)})},Layout.ForceDirected.prototype.updatePosition=function(e){this.eachNode(function(t,n){n.p=n.p.add(n.v.multiply(e))})},Layout.ForceDirected.prototype.totalEnergy=function(e){var t=0;return this.eachNode(function(e,n){var r=n.v.magnitude();t+=.5*n.m*r*r}),t};var __bind=function(e,t){return function(){return e.apply(t,arguments)}};Layout.requestAnimationFrame=__bind(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,10)},window),Layout.ForceDirected.prototype.start=function(e,t){var n=this;if(this._started)return;this._started=!0,this._stop=!1,Layout.requestAnimationFrame(function r(){n.applyCoulombsLaw(),n.applyHookesLaw(),n.attractToCentre(),n.updateVelocity(.03),n.updatePosition(.03),e!==undefined&&e(),n._stop||n.totalEnergy()<.01?(n._started=!1,t!==undefined&&t()):Layout.requestAnimationFrame(r)})},Layout.ForceDirected.prototype.stop=function(){this._stop=!0},Layout.ForceDirected.prototype.nearest=function(e){var t={node:null,point:null,distance:null},n=this;return this.graph.nodes.forEach(function(r){var i=n.point(r),s=i.p.subtract(e).magnitude();if(t.distance===null||s<t.distance)t={node:r,point:i,distance:s}}),t},Layout.ForceDirected.prototype.getBoundingBox=function(){var e=new Vector(-2,-2),t=new Vector(2,2);this.eachNode(function(n,r){r.p.x<e.x&&(e.x=r.p.x),r.p.y<e.y&&(e.y=r.p.y),r.p.x>t.x&&(t.x=r.p.x),r.p.y>t.y&&(t.y=r.p.y)});var n=t.subtract(e).multiply(.07);return{bottomleft:e.subtract(n),topright:t.add(n)}};var Vector=function(e,t){this.x=e,this.y=t};Vector.random=function(){return new Vector(10*(Math.random()-.5),10*(Math.random()-.5))},Vector.prototype.add=function(e){return new Vector(this.x+e.x,this.y+e.y)},Vector.prototype.subtract=function(e){return new Vector(this.x-e.x,this.y-e.y)},Vector.prototype.multiply=function(e){return new Vector(this.x*e,this.y*e)},Vector.prototype.divide=function(e){return new Vector(this.x/e||0,this.y/e||0)},Vector.prototype.magnitude=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},Vector.prototype.normal=function(){return new Vector(-this.y,this.x)},Vector.prototype.normalise=function(){return this.divide(this.magnitude())},Layout.ForceDirected.Point=function(e,t){this.p=e,this.m=t,this.v=new Vector(0,0),this.a=new Vector(0,0)},Layout.ForceDirected.Point.prototype.applyForce=function(e){this.a=this.a.add(e.divide(this.m))},Layout.ForceDirected.Spring=function(e,t,n,r){this.point1=e,this.point2=t,this.length=n,this.k=r},Renderer.prototype.graphChanged=function(e){this.start()},Renderer.prototype.start=function(){var e=this;this.layout.start(function(){e.clear(),e.layout.eachEdge(function(n,r){e.drawEdge(n,r.point1.p,r.point2.p)}),e.layout.eachNode(function(n,r){e.drawNode(n,r.p)})})},Renderer.prototype.stop=function(){this.layout.stop()},Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var n,r;if(this==null)throw new TypeError(" this is null or not defined");var i=Object(this),s=i.length>>>0;if({}.toString.call(e)!="[object Function]")throw new TypeError(e+" is not a function");t&&(n=t),r=0;while(r<s){var o;r in i&&(o=i[r],e.call(n,o,r,i)),r++}});